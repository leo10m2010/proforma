<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proforma ‚Äî Tato</title>
  <style>
    :root {
      --primary: #0f172a;
      --accent: #c6a769;
      --muted: #64748b;
      --border: #e5e7eb;
      --bg: #ffffff;
      --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    @page {
      size: A4;
      margin: 10mm;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--primary);
      background: var(--bg);
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .page {
      width: 100%;
      max-width: 210mm;
      margin: auto;
      padding: 18px;
      background: #fff;
      border-radius: 12px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 8px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand picture.logo, .brand img#logo {
      height: 50px;
      width: auto;
      display: block;
    }

    .brand h1 { font-size: 22px; margin: 0; }

    .titlebox { text-align: right; }
    .titlebox h2 { margin: 0; font-size: 20px; text-transform: uppercase; }
    .badge { background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 20px; font-size: 11px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .panel { border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
    .kv { display: grid; grid-template-columns: 110px 1fr; font-size: 13px; row-gap: 4px; }

    .section-title { margin: 14px 0 6px; font-size: 14px; color: var(--muted); text-transform: uppercase; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { text-transform: uppercase; font-size: 11px; color: var(--muted); }
    .price { text-align: right; font-weight: 700; }

    .incl { font-size: 12px; color: var(--muted); line-height: 1.4; }

    .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .card { border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-size: 12px; }
    .card h4 { margin: 0 0 4px; font-size: 13px; }

    .totals { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; }

    .cta { margin-top: 10px; border: 1px dashed var(--border); border-radius: 8px; padding: 8px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
    .cta a { text-decoration: none; font-weight: 600; color: #fff; background: var(--primary); padding: 6px 10px; border-radius: 20px; font-size: 12px; }

    footer { border-top: 1px solid var(--border); margin-top: 12px; padding-top: 6px; font-size: 11px; color: var(--muted); display: flex; justify-content: space-between; }

    .actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .btn { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; background: #fff; }
    .btn--primary { background: var(--primary); color: #fff; }
    .btn--success { background: #059669; color: #fff; }
    .btn--warning { background: #d97706; color: #fff; }
    
    .management-panel { 
      background: #f8fafc; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 12px; 
      margin-bottom: 16px; 
      display: none; 
    }
    .management-panel.active { display: block; }
    
    .user-selector {
      background: var(--primary);
      color: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-select {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      background: white;
      color: var(--primary);
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    
    .profile-panel {
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      display: none;
    }
    .profile-panel.active { display: block; }
    .profile-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      font-size: 12px;
    }
    .profile-form input, .profile-form textarea {
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
    }
    
    .auth-panel {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    .auth-form {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 12px;
    }
    .auth-form input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
    }
    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      margin-top: 8px;
    }
    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
    }
    .sync-indicator.offline {
      background: #f59e0b;
    }
    .sync-indicator.error {
      background: #ef4444;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      background: white;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-left: 4px solid;
      max-width: 350px;
      display: flex;
      align-items: center;
      gap: 8px;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      font-size: 13px;
    }
    .toast.show {
      transform: translateX(0);
    }
    .toast.success {
      border-color: #10b981;
      background: #f0fdf4;
    }
    .toast.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    .toast.warning {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .toast.info {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .toast-icon {
      font-size: 16px;
      flex-shrink: 0;
    }
    .toast-content {
      flex: 1;
    }
    .toast-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .toast-message {
      color: var(--muted);
      font-size: 12px;
    }
    .toast-close {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      opacity: 0.5;
      flex-shrink: 0;
    }
    .toast-close:hover {
      opacity: 1;
    }
    .saved-proformas { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 8px; 
      margin-top: 8px; 
    }
    .saved-item { 
      background: #fff; 
      border: 1px solid var(--border); 
      border-radius: 6px; 
      padding: 8px; 
      font-size: 12px; 
    }
    .saved-item .actions-small { 
      display: flex; 
      gap: 4px; 
      margin-top: 6px; 
    }
    .btn-small { 
      padding: 3px 6px; 
      font-size: 10px; 
      border-radius: 4px; 
      border: 1px solid var(--border); 
      cursor: pointer; 
    }

    @media print {
      body { background: white !important; }
      .page { 
        border: none; 
        box-shadow: none; 
        margin: 0; 
        padding: 15mm; 
        max-width: none;
        width: 100%;
      }
      .actions, .btn, .cta, .management-panel, .user-selector, .profile-panel, .auth-panel { 
        display: none !important; 
      }
      header { margin-bottom: 20px; }
      .section-title { margin-top: 20px; }
      table { page-break-inside: avoid; }
      .grid-2 { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="page" id="doc">
    <header>
      <div class="brand">
        <picture class="logo">
          <source type="image/webp" srcset="https://res.cloudinary.com/renatoez/image/upload/v1755882448/Untitled_qmza6o.svg" />
          <img id="logo" alt="Logo Tato" decoding="async" loading="eager" src="https://res.cloudinary.com/renatoez/image/upload/v1755882448/Untitled_qmza6o.svg" />
        </picture>
        <div>
          <small>Soluciones Web Profesionales</small>
        </div>
      </div>
      <div class="titlebox">
        <h2>Proforma</h2>
        <span class="badge">Documento no fiscal</span>
      </div>
    </header>

    <div class="auth-panel" id="auth-panel">
      <h3 style="margin: 0 0 8px; font-size: 14px;">‚òÅÔ∏è Sincronizaci√≥n R√°pida</h3>
      <p style="margin: 0 0 8px; font-size: 12px; color: var(--muted);">
        Ingresa tu PIN para sincronizar proformas instant√°neamente
      </p>
      <div class="auth-form" id="auth-form">
        <input type="password" id="user-pin" placeholder="PIN (4 d√≠gitos)" maxlength="4" style="flex: 1; max-width: 150px; text-align: center; font-size: 16px; letter-spacing: 2px;">
        <button class="btn btn--primary" id="login-btn">üîë Conectar</button>
        <button class="btn" id="work-offline">üì± Sin conexi√≥n</button>
      </div>
      <div class="sync-status" id="sync-status" style="display: none;">
        <div class="sync-indicator" id="sync-indicator"></div>
        <span id="sync-text">Conectado y sincronizado</span>
        <button class="btn" id="logout-btn" style="margin-left: auto;">üö™ Desconectar</button>
      </div>
    </div>

    <div class="user-selector">
      <div class="user-info">
        üë§ <strong>Usuario:</strong>
        <select class="user-select" id="user-select">
          <option value="tato">Tato (Renato)</option>
          <option value="kike">Kike</option>
          <option value="carlos">Carlos</option>
        </select>
        <button class="btn" id="config-profile" style="margin-left: 10px;">‚öôÔ∏è Configurar</button>
      </div>
      <div style="font-size: 11px; opacity: 0.8;">
        Cada usuario tiene sus propias proformas y numeraci√≥n
      </div>
    </div>

    <div class="profile-panel" id="profile-panel">
      <h3 style="margin: 0 0 12px; font-size: 14px;">‚öôÔ∏è Configuraci√≥n de Perfil</h3>
      <div class="profile-form">
        <div>
          <label><strong>Nombre/Empresa:</strong></label>
          <input type="text" id="profile-name" placeholder="Ej: Tato Solutions">
        </div>
        <div>
          <label><strong>Tagline:</strong></label>
          <input type="text" id="profile-tagline" placeholder="Ej: Soluciones Web Profesionales">
        </div>
        <div>
          <label><strong>Email:</strong></label>
          <input type="email" id="profile-email" placeholder="contacto@ejemplo.com">
        </div>
        <div>
          <label><strong>Tel√©fono/WhatsApp:</strong></label>
          <input type="text" id="profile-phone" placeholder="+51 975 212 132">
        </div>
        <div style="grid-column: 1 / -1;">
          <label><strong>URL del Logo:</strong></label>
          <input type="url" id="profile-logo" placeholder="https://mi-logo.com/logo.svg">
          <small style="color: var(--muted); display: block; margin-top: 4px;">
            Puedes usar Cloudinary, Imgur o cualquier URL de imagen
          </small>
        </div>
        <div>
          <label><strong>PIN de Sincronizaci√≥n:</strong></label>
          <input type="password" id="profile-pin" placeholder="4 d√≠gitos" maxlength="4" style="text-align: center; letter-spacing: 2px;">
          <small style="color: var(--muted); display: block; margin-top: 2px;">
            Para sincronizar tus datos en la nube
          </small>
        </div>
        <div>
          <label><strong>Confirmar PIN:</strong></label>
          <input type="password" id="profile-pin-confirm" placeholder="4 d√≠gitos" maxlength="4" style="text-align: center; letter-spacing: 2px;">
        </div>
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn btn--success" id="save-profile">üíæ Guardar Perfil</button>
        <button class="btn" id="cancel-profile">‚ùå Cancelar</button>
      </div>
    </div>

    <div class="management-panel" id="management-panel">
      <h3 style="margin: 0 0 8px; font-size: 14px;">üìÅ Gesti√≥n de Proformas</h3>
      <div class="actions">
        <button class="btn btn--success" id="save-proforma">üíæ Guardar</button>
        <button class="btn btn--warning" id="new-proforma">üìÑ Nueva</button>
        <button class="btn" id="export-data">üì§ Exportar Datos</button>
        <button class="btn" id="import-data">üì• Importar Datos</button>
        <input type="file" id="import-file" accept=".json" style="display: none;">
      </div>
      <div class="saved-proformas" id="saved-proformas">
        <!-- Las proformas guardadas aparecer√°n aqu√≠ -->
      </div>
    </div>

    <section class="grid-2">
      <div class="panel">
        <h3>Datos de la Proforma</h3>
        <div class="kv">
          <strong>N¬∫ Proforma</strong><span id="pf-number">PRO-2025-001</span>
          <strong>Fecha</strong><span id="pf-date">‚Äî</span>
          <strong>Validez</strong><span>15 d√≠as calendario</span>
        </div>
      </div>
      <div class="panel">
        <h3>Datos del Cliente</h3>
        <div class="kv">
          <strong>Cliente</strong><span contenteditable="true">[Nombre / Empresa]</span>
          <strong>Contacto</strong><span contenteditable="true">[Correo] ¬∑ [Tel/WhatsApp]</span>
          <strong>RUC / ID</strong><span contenteditable="true">[Opcional]</span>
        </div>
      </div>
    </section>

    <h3 class="section-title">Opciones de desarrollo web</h3>
    <table>
      <thead>
        <tr>
          <th>Opci√≥n</th>
          <th>Descripci√≥n</th>
          <th class="price">Precio (S/)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td contenteditable="true">Opci√≥n 1 ‚Äî WordPress</td>
          <td class="incl" contenteditable="true">‚Ä¢ Dise√±o personalizado y responsive.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculado a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Capacitaci√≥n b√°sica.</td>
          <td class="price" contenteditable="true">2,000.00</td>
        </tr>
        <tr>
          <td contenteditable="true">Opci√≥n 2 ‚Äî Next.js</td>
          <td class="incl" contenteditable="true">‚Ä¢ Arquitectura moderna con alto rendimiento y SEO t√©cnico.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculada a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Dise√±o moderno y escalable.</td>
          <td class="price" contenteditable="true">3,000.00</td>
        </tr>
      </tbody>
    </table>

    <div class="cards">
      <div class="card">
        <h4>Incluye</h4>
        <div contenteditable="true">Puesta en producci√≥n ¬∑ Optimizado m√≥viles ¬∑ Capacitaci√≥n b√°sica</div>
      </div>
      <div class="card">
        <h4>No incluye</h4>
        <div contenteditable="true">Hosting y dominio (se cotizan aparte).</div>
      </div>
    </div>

    <div class="totals">
      <div>
        <p><strong>Plazo estimado:</strong> <span contenteditable="true">2‚Äì4 semanas</span>.</p>
        <p contenteditable="true">Los precios incluyen desarrollo e implementaci√≥n. Esta proforma no constituye comprobante de pago.</p>
      </div>
      <div><strong>Opciones:</strong><br><span id="price-summary">S/ 2,000.00 ¬∑ S/ 3,000.00</span></div>
    </div>

    <div class="cta">
      <div>
        <strong>¬øListo para empezar?</strong><br>
        <small>Elige una opci√≥n y coordinemos el inicio.</small>
      </div>
      <a id="cta-wsp" href="https://wa.me/51975212132" target="_blank">WhatsApp</a>
    </div>

    <div class="actions">
      <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      <button class="btn btn--primary" id="fill-demo">üéØ Rellenar demo</button>
      <button class="btn" id="toggle-management">üìÅ Gestionar Proformas</button>
    </div>

    <footer>
      <div>
        ¬© <span id="year"></span> Tato ¬∑ renato.espinoza.medrano@gmail.com ¬∑ +51 975 212 132
      </div>
      <div>
        Gracias por considerar a Tato ‚ù§Ô∏è
      </div>
    </footer>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Configuraci√≥n de Supabase
    // NOTA: Estas claves son seguras para uso p√∫blico
    // Las pol√≠ticas RLS protegen tus datos privados
    const SUPABASE_URL = 'https://zenywgqwuzofmswilwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inplbnl3Z3F3dXpvZm1zd2lsd3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODc2MTEsImV4cCI6MjA3MTQ2MzYxMX0.dBhAmrtTw2VSMCrL71MgG7_V85Qy-iApL6LFfNFEulc';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Sistema de Toast Notifications
    class ToastManager {
      static show(message, type = 'info', title = '', duration = 5000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        
        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            ${title ? `<div class="toast-title">${title}</div>` : ''}
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;
        
        container.appendChild(toast);
        
        // Animaci√≥n de entrada
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto-remover
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // Sistema de gesti√≥n de proformas multi-usuario con Supabase
    class ProformaManager {
      constructor() {
        this.currentUser = 'tato';
        this.currentProforma = null;
        this.userProfiles = this.getDefaultProfiles();
        this.isOnline = false;
        this.currentSupabaseUser = null;
        this.syncQueue = [];
        this.pendingSync = []; // Cola de sincronizaci√≥n offline
        this.init();
      }

      getDefaultProfiles() {
        return {
          tato: {
            name: 'Tato',
            tagline: 'Soluciones Web Profesionales',
            email: 'renato.espinoza.medrano@gmail.com',
            phone: '+51 975 212 132',
            logo: 'https://res.cloudinary.com/renatoez/image/upload/v1755882448/Untitled_qmza6o.svg',
            pin: '1234' // PIN por defecto
          },
          kike: {
            name: 'Kike',
            tagline: 'Desarrollo Web & Dise√±o',
            email: 'kike@ejemplo.com',
            phone: '+51 999 888 777',
            logo: '',
            pin: '5678' // PIN por defecto
          },
          carlos: {
            name: 'Carlos',
            tagline: 'Soluciones Digitales',
            email: 'carlos@ejemplo.com',
            phone: '+51 888 777 666',
            logo: '',
            pin: '9012' // PIN por defecto
          }
        };
      }

      getStorageKey(type = 'proformas') {
        return `${this.currentUser}-${type}`;
      }

      async init() {
        this.loadUserProfiles();
        this.loadCurrentUser();
        this.loadPendingSync(); // Cargar cola de sincronizaci√≥n
        this.setCurrentDate();
        this.setupLogoFallback();
        this.bindEvents();
        this.updateUserInterface();
        this.setupConnectionMonitoring(); // Nuevo: monitoreo de conexi√≥n
        await this.checkSupabaseAuth();
        this.loadSavedProformas();
        this.autoSave();
      }

      loadPendingSync() {
        const pending = localStorage.getItem('pending-sync');
        if (pending) {
          this.pendingSync = JSON.parse(pending);
          if (this.pendingSync.length > 0) {
            ToastManager.show(`${this.pendingSync.length} cambios pendientes de sincronizar`, 'info', 'Sincronizaci√≥n pendiente');
          }
        }
      }

      setupConnectionMonitoring() {
        // Detectar cuando regresa la conexi√≥n
        window.addEventListener('online', () => {
          ToastManager.show('Conexi√≥n restaurada. Sincronizando...', 'info', 'Conexi√≥n restaurada');
          this.syncPendingData();
        });

        window.addEventListener('offline', () => {
          ToastManager.show('Sin conexi√≥n. Guardando localmente', 'warning', 'Modo offline');
          this.isOnline = false;
          this.updateSyncStatus('offline', 'Sin conexi√≥n');
        });

        // Verificar conexi√≥n peri√≥dicamente
        setInterval(() => {
          if (navigator.onLine && !this.isOnline) {
            this.syncPendingData();
          }
        }, 30000); // Cada 30 segundos
      }

      async syncPendingData() {
        if (this.pendingSync.length === 0) return;

        try {
          ToastManager.show(`Sincronizando ${this.pendingSync.length} cambios...`, 'info', 'Sincronizaci√≥n autom√°tica');
          
          for (const item of this.pendingSync) {
            if (item.type === 'proforma') {
              await this.syncProformaToSupabase(item.data);
            } else if (item.type === 'profile') {
              await this.syncProfileToSupabase();
            }
          }
          
          this.pendingSync = [];
          localStorage.removeItem('pending-sync');
          ToastManager.show('Todos los cambios sincronizados', 'success', 'Sincronizaci√≥n completa');
          
        } catch (error) {
          ToastManager.show('Error en sincronizaci√≥n autom√°tica', 'error', 'Error de sincronizaci√≥n');
        }
      }

      async checkSupabaseAuth() {
        try {
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
            this.currentSupabaseUser = user;
            this.isOnline = true;
            this.updateAuthUI();
            await this.syncFromSupabase();
          }
        } catch (error) {
          console.log('Sin conexi√≥n a Supabase, trabajando offline');
          this.updateSyncStatus('offline', 'Trabajando sin conexi√≥n');
        }
      }

      updateAuthUI() {
        const authPanel = document.getElementById('auth-panel');
        const authForm = document.getElementById('auth-form');
        const syncStatus = document.getElementById('sync-status');
        
        if (this.currentSupabaseUser) {
          authForm.style.display = 'none';
          syncStatus.style.display = 'flex';
          document.getElementById('sync-text').textContent = 
            `Conectado: ${this.currentSupabaseUser.email}`;
          this.updateSyncStatus('online', 'Sincronizado');
        } else {
          authForm.style.display = 'flex';
          syncStatus.style.display = 'none';
        }
      }

      updateSyncStatus(status, text) {
        const indicator = document.getElementById('sync-indicator');
        const syncText = document.getElementById('sync-text');
        
        indicator.className = `sync-indicator ${status === 'online' ? '' : status}`;
        if (syncText) syncText.textContent = text;
      }

      loadUserProfiles() {
        const saved = localStorage.getItem('user-profiles');
        if (saved) {
          this.userProfiles = { ...this.getDefaultProfiles(), ...JSON.parse(saved) };
        }
      }

      saveUserProfiles() {
        localStorage.setItem('user-profiles', JSON.stringify(this.userProfiles));
      }

      loadCurrentUser() {
        const saved = localStorage.getItem('current-user');
        if (saved) {
          this.currentUser = saved;
        }
        document.getElementById('user-select').value = this.currentUser;
      }

      saveCurrentUser() {
        localStorage.setItem('current-user', this.currentUser);
      }

      updateUserInterface() {
        const profile = this.userProfiles[this.currentUser];
        
        // Actualizar logo y datos en el header
        if (profile.logo) {
          document.getElementById('logo').src = profile.logo;
          document.querySelector('.logo source').srcset = profile.logo;
        }
        
        // Actualizar nombre y tagline en el brand
        const brandDiv = document.querySelector('.brand div');
        if (!brandDiv.querySelector('h1')) {
          brandDiv.innerHTML = `<h1>${profile.name}</h1><small>${profile.tagline}</small>`;
        } else {
          brandDiv.querySelector('h1').textContent = profile.name;
          brandDiv.querySelector('small').textContent = profile.tagline;
        }
        
        // Actualizar footer
        const year = new Date().getFullYear();
        document.querySelector('footer div').innerHTML = 
          `¬© ${year} ${profile.name} ¬∑ ${profile.email} ¬∑ ${profile.phone}`;
      }

      setCurrentDate() {
        const d = new Date();
        const opts = { year: 'numeric', month: 'long', day: '2-digit' };
        document.getElementById('pf-date').textContent = d.toLocaleDateString('es-PE', opts);
        document.getElementById('year').textContent = d.getFullYear();
      }

      setupLogoFallback() {
        const logo = document.getElementById('logo');
        logo && logo.addEventListener('error', () => {
          logo.onerror = null;
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='140' height='40'><rect width='100%' height='100%' fill='%230f172a'/><text x='50%' y='50%' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='18' text-anchor='middle' dominant-baseline='middle'>Tato</text></svg>`;
          logo.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        });
      }

      bindEvents() {
        // Eventos existentes
        document.getElementById('fill-demo').addEventListener('click', () => this.fillDemo());
        document.getElementById('toggle-management').addEventListener('click', () => this.toggleManagement());
        document.getElementById('save-proforma').addEventListener('click', () => this.saveCurrentProforma());
        document.getElementById('new-proforma').addEventListener('click', () => this.newProforma());
        document.getElementById('export-data').addEventListener('click', () => this.exportData());
        document.getElementById('import-data').addEventListener('click', () => document.getElementById('import-file').click());
        document.getElementById('import-file').addEventListener('change', (e) => this.importData(e));

        // Nuevos eventos de usuario
        document.getElementById('user-select').addEventListener('change', (e) => this.switchUser(e.target.value));
        document.getElementById('config-profile').addEventListener('click', () => this.toggleProfilePanel());
        document.getElementById('save-profile').addEventListener('click', () => this.saveProfile());
        document.getElementById('cancel-profile').addEventListener('click', () => this.toggleProfilePanel());

        // Eventos de autenticaci√≥n
        document.getElementById('login-btn').addEventListener('click', () => this.loginWithPin());
        document.getElementById('logout-btn').addEventListener('click', () => this.logout());
        document.getElementById('work-offline').addEventListener('click', () => this.workOffline());
        
        // Permitir login con Enter
        document.getElementById('user-pin').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.loginWithPin();
        });

        // Auto-actualizar resumen de precios
        document.addEventListener('input', (e) => {
          if (e.target.classList.contains('price')) {
            this.updatePriceSummary();
          }
        });
      }

      switchUser(newUser) {
        if (this.currentUser !== newUser) {
          this.currentUser = newUser;
          this.saveCurrentUser();
          this.updateUserInterface();
          this.loadSavedProformas();
          // Crear nueva proforma para el usuario
          this.newProforma(false); // false = no mostrar confirmaci√≥n
        }
      }

      toggleProfilePanel() {
        const panel = document.getElementById('profile-panel');
        panel.classList.toggle('active');
        
        if (panel.classList.contains('active')) {
          // Cargar datos actuales del perfil
          const profile = this.userProfiles[this.currentUser];
          document.getElementById('profile-name').value = profile.name;
          document.getElementById('profile-tagline').value = profile.tagline;
          document.getElementById('profile-email').value = profile.email;
          document.getElementById('profile-phone').value = profile.phone;
          document.getElementById('profile-logo').value = profile.logo;
          document.getElementById('profile-pin').value = profile.pin || '';
          document.getElementById('profile-pin-confirm').value = profile.pin || '';
        }
      }

      saveProfile() {
        const pin = document.getElementById('profile-pin').value;
        const pinConfirm = document.getElementById('profile-pin-confirm').value;
        
        // Validar PIN
        if (pin && pin !== pinConfirm) {
          ToastManager.show('Los PINs no coinciden', 'error', 'Error de validaci√≥n');
          return;
        }
        
        if (pin && (pin.length !== 4 || !/^\d{4}$/.test(pin))) {
          ToastManager.show('El PIN debe tener exactamente 4 d√≠gitos', 'error', 'PIN inv√°lido');
          return;
        }

        const profile = {
          name: document.getElementById('profile-name').value,
          tagline: document.getElementById('profile-tagline').value,
          email: document.getElementById('profile-email').value,
          phone: document.getElementById('profile-phone').value,
          logo: document.getElementById('profile-logo').value,
          pin: pin || this.userProfiles[this.currentUser].pin // Mantener PIN anterior si no se cambia
        };

        this.userProfiles[this.currentUser] = profile;
        this.saveUserProfiles();
        this.updateUserInterface();
        this.toggleProfilePanel();
        
        if (pin && pin !== this.userProfiles[this.currentUser].pin) {
          ToastManager.show('PIN actualizado correctamente', 'success', `Perfil de ${profile.name}`);
        } else {
          ToastManager.show('Configuraci√≥n actualizada', 'success', `Perfil de ${profile.name}`);
        }
        
        // Sincronizar perfil con Supabase si est√° conectado
        if (this.isOnline) {
          this.syncProfileToSupabase();
        } else {
          // Agregar a cola de sincronizaci√≥n
          this.pendingSync.push({ type: 'profile', data: profile });
          localStorage.setItem('pending-sync', JSON.stringify(this.pendingSync));
        }
      }

      async loginWithPin() {
        const pin = document.getElementById('user-pin').value;
        const userProfile = this.userProfiles[this.currentUser];
        
        if (!pin) {
          ToastManager.show('Por favor ingresa tu PIN', 'warning', 'PIN requerido');
          return;
        }

        if (pin !== userProfile.pin) {
          ToastManager.show('PIN incorrecto para este usuario', 'error', 'Acceso denegado');
          document.getElementById('user-pin').value = '';
          return;
        }

        try {
          this.updateSyncStatus('sync', 'Conectando...');
          
          // Simular usuario con el PIN como ID √∫nico
          this.currentSupabaseUser = {
            id: `user_${this.currentUser}_${pin}`,
            pin: pin,
            username: this.currentUser
          };
          
          this.isOnline = true;
          this.updateAuthUI();
          await this.syncFromSupabase();
          ToastManager.show('Datos sincronizados desde la nube', 'success', '¬°Conectado exitosamente!');

        } catch (error) {
          console.error('Error de conexi√≥n:', error);
          ToastManager.show('Error al conectar con la nube', 'error', 'Error de conexi√≥n');
          this.updateSyncStatus('error', 'Error de conexi√≥n');
        }
      }

      async logout() {
        try {
          await supabase.auth.signOut();
          this.currentSupabaseUser = null;
          this.isOnline = false;
          this.updateAuthUI();
          this.updateSyncStatus('offline', 'Desconectado');
          ToastManager.show('Los datos se guardan localmente', 'info', 'Desconectado');
        } catch (error) {
          console.error('Error al desconectar:', error);
          ToastManager.show('Error al desconectar', 'error');
        }
      }

      workOffline() {
        document.getElementById('auth-panel').style.display = 'none';
        ToastManager.show('Los datos se guardan localmente en tu navegador', 'info', 'Modo sin conexi√≥n');
      }

      async syncFromSupabase() {
        if (!this.isOnline || !this.currentSupabaseUser) return;

        try {
          this.updateSyncStatus('sync', 'Sincronizando...');

          // Crear tablas si no existen
          await this.createTablesIfNeeded();

          // Sincronizar perfiles
          await this.syncProfileFromSupabase();
          
          // Sincronizar proformas
          await this.syncProformasFromSupabase();

          this.updateSyncStatus('online', 'Sincronizado');
          
        } catch (error) {
          console.error('Error de sincronizaci√≥n:', error);
          this.updateSyncStatus('error', 'Error de sincronizaci√≥n');
        }
      }

      async createTablesIfNeeded() {
        try {
          // Intentar crear las tablas si no existen
          await supabase.rpc('create_tables_if_not_exist');
        } catch (error) {
          // Si la funci√≥n no existe, crear las tablas directamente
          console.log('Creando tablas autom√°ticamente...');
          
          // Crear una proforma de prueba para que se cree la tabla
          try {
            await supabase.from('user_profiles').select('*').limit(1);
            await supabase.from('proformas').select('*').limit(1);
          } catch (tableError) {
            ToastManager.show('Las tablas se crear√°n autom√°ticamente cuando guardes datos', 'info', 'Base de datos');
          }
        }
      }

      async syncProfileToSupabase() {
        if (!this.isOnline) return;

        try {
          const { error } = await supabase
            .from('user_profiles')
            .upsert({
              user_id: this.currentSupabaseUser.id,
              email: this.currentSupabaseUser.email,
              username: this.currentUser,
              profile_data: this.userProfiles[this.currentUser]
            });

          if (error) throw error;
        } catch (error) {
          console.error('Error sincronizando perfil:', error);
        }
      }

      async syncProfileFromSupabase() {
        if (!this.isOnline) return;

        try {
          const { data, error } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('user_id', this.currentSupabaseUser.id)
            .single();

          if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows
          
          if (data && data.profile_data) {
            this.userProfiles[data.username] = data.profile_data;
            this.saveUserProfiles();
          }
        } catch (error) {
          console.error('Error cargando perfil:', error);
        }
      }

      async syncProformasFromSupabase() {
        if (!this.isOnline) return;

        try {
          const { data, error } = await supabase
            .from('proformas')
            .select('*')
            .eq('user_id', this.currentSupabaseUser.id)
            .eq('username', this.currentUser);

          if (error) throw error;

          if (data && data.length > 0) {
            const supabaseProformas = data.map(item => item.proforma_data);
            localStorage.setItem(this.getStorageKey(), JSON.stringify(supabaseProformas));
            this.loadSavedProformas();
          }
        } catch (error) {
          console.error('Error cargando proformas:', error);
        }
      }

      generateProformaNumber() {
        const year = new Date().getFullYear();
        const saved = this.getSavedProformas();
        const currentYearProformas = saved.filter(p => p.number.includes(year.toString()));
        const nextNumber = String(currentYearProformas.length + 1).padStart(3, '0');
        
        // Prefijo personalizado por usuario
        const prefixes = {
          tato: 'TAT',
          kike: 'KIK', 
          carlos: 'CAR'
        };
        
        const prefix = prefixes[this.currentUser] || 'PRO';
        return `${prefix}-${year}-${nextNumber}`;
      }

      fillDemo() {
        const editables = document.querySelectorAll('[contenteditable]');
        editables[0].textContent = 'Comercial Andina SAC';
        editables[1].textContent = 'compras@comercialandina.pe ¬∑ +51 987 654 321';
        editables[2].textContent = '2060xxxxxxx';
        
        const proformaNumber = this.generateProformaNumber();
        document.getElementById('pf-number').textContent = proformaNumber;

        const profile = this.userProfiles[this.currentUser];
        const msg = encodeURIComponent(`Hola ${profile.name}, estoy interesado en la Proforma ${proformaNumber}. Quiero avanzar con mi sitio web.`);
        const phone = profile.phone.replace(/[\s\-\+]/g, '');
        document.getElementById('cta-wsp').href = `https://wa.me/${phone}?text=${msg}`;
      }

      toggleManagement() {
        const panel = document.getElementById('management-panel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
          this.loadSavedProformas();
        }
      }

      collectFormData() {
        const data = {
          number: document.getElementById('pf-number').textContent,
          date: document.getElementById('pf-date').textContent,
          client: {
            name: document.querySelectorAll('[contenteditable]')[0].textContent,
            contact: document.querySelectorAll('[contenteditable]')[1].textContent,
            ruc: document.querySelectorAll('[contenteditable]')[2].textContent
          },
          options: [],
          includes: document.querySelectorAll('.card div[contenteditable]')[0].textContent,
          excludes: document.querySelectorAll('.card div[contenteditable]')[1].textContent,
          timeline: document.querySelector('.totals span[contenteditable]').textContent,
          terms: document.querySelector('.totals p[contenteditable]').textContent,
          timestamp: new Date().toISOString()
        };

        // Recoger opciones de la tabla
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td[contenteditable]');
          if (cells.length >= 3) {
            data.options.push({
              name: cells[0].textContent,
              description: cells[1].innerHTML,
              price: cells[2].textContent
            });
          }
        });

        return data;
      }

      fillFormData(data) {
        document.getElementById('pf-number').textContent = data.number;
        
        const editables = document.querySelectorAll('[contenteditable]');
        editables[0].textContent = data.client.name;
        editables[1].textContent = data.client.contact;
        editables[2].textContent = data.client.ruc;

        // Llenar opciones
        const rows = document.querySelectorAll('tbody tr');
        data.options.forEach((option, index) => {
          if (rows[index]) {
            const cells = rows[index].querySelectorAll('td[contenteditable]');
            if (cells.length >= 3) {
              cells[0].textContent = option.name;
              cells[1].innerHTML = option.description;
              cells[2].textContent = option.price;
            }
          }
        });

        // Llenar otros campos
        document.querySelectorAll('.card div[contenteditable]')[0].textContent = data.includes;
        document.querySelectorAll('.card div[contenteditable]')[1].textContent = data.excludes;
        document.querySelector('.totals span[contenteditable]').textContent = data.timeline;
        document.querySelector('.totals p[contenteditable]').textContent = data.terms;

        this.updatePriceSummary();
      }

      async saveCurrentProforma() {
        const data = this.collectFormData();
        const saved = this.getSavedProformas();
        
        // Verificar si ya existe
        const existingIndex = saved.findIndex(p => p.number === data.number);
        
        if (existingIndex >= 0) {
          saved[existingIndex] = data;
          ToastManager.show(`Cambios guardados correctamente`, 'success', `Proforma ${data.number}`);
        } else {
          saved.push(data);
          ToastManager.show(`Nueva proforma creada y guardada`, 'success', `Proforma ${data.number}`);
        }
        
        // Guardar localmente
        localStorage.setItem(this.getStorageKey(), JSON.stringify(saved));
        
        // Sincronizar con Supabase si est√° conectado
        if (this.isOnline) {
          await this.syncProformaToSupabase(data);
        } else {
          // Agregar a cola de sincronizaci√≥n offline
          this.pendingSync.push({ type: 'proforma', data: data });
          localStorage.setItem('pending-sync', JSON.stringify(this.pendingSync));
          ToastManager.show('Se sincronizar√° cuando regrese la conexi√≥n', 'info', 'Guardado offline');
        }
        
        this.loadSavedProformas();
      }

      async syncProformaToSupabase(proformaData) {
        if (!this.isOnline) return;

        try {
          const { error } = await supabase
            .from('proformas')
            .upsert({
              user_id: this.currentSupabaseUser.id,
              username: this.currentUser,
              proforma_number: proformaData.number,
              proforma_data: proformaData
            });

          if (error) throw error;
          console.log('Proforma sincronizada con Supabase');
        } catch (error) {
          console.error('Error sincronizando proforma:', error);
          this.updateSyncStatus('error', 'Error de sincronizaci√≥n');
        }
      }

      newProforma(showConfirm = true) {
        if (!showConfirm || this.confirmAction('¬øCrear nueva proforma?', 'Los cambios no guardados se perder√°n')) {
          // Limpiar todos los campos editables
          document.querySelectorAll('[contenteditable]').forEach(el => {
            if (el.innerHTML.includes('[')) return; // Mantener placeholders
            el.textContent = '';
          });
          
          // Resetear datos
          const proformaNumber = this.generateProformaNumber();
          document.getElementById('pf-number').textContent = proformaNumber;
          this.setCurrentDate();
          
          // Resetear opciones a valores por defecto
          const rows = document.querySelectorAll('tbody tr');
          const defaultOptions = [
            {
              name: 'Opci√≥n 1 ‚Äî WordPress',
              description: '‚Ä¢ Dise√±o personalizado y responsive.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculado a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Capacitaci√≥n b√°sica.',
              price: '2,000.00'
            },
            {
              name: 'Opci√≥n 2 ‚Äî Next.js',
              description: '‚Ä¢ Arquitectura moderna con alto rendimiento y SEO t√©cnico.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculada a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Dise√±o moderno y escalable.',
              price: '3,000.00'
            }
          ];
          
          rows.forEach((row, index) => {
            if (defaultOptions[index]) {
              const cells = row.querySelectorAll('td[contenteditable]');
              cells[0].textContent = defaultOptions[index].name;
              cells[1].innerHTML = defaultOptions[index].description;
              cells[2].textContent = defaultOptions[index].price;
            }
          });
          
          this.updatePriceSummary();
          if (showConfirm) ToastManager.show('Formulario limpio y listo para nueva proforma', 'success', 'Nueva proforma');
        }
      }

      getSavedProformas() {
        const saved = localStorage.getItem(this.getStorageKey());
        return saved ? JSON.parse(saved) : [];
      }

      loadSavedProformas() {
        const saved = this.getSavedProformas();
        const container = document.getElementById('saved-proformas');
        
        if (saved.length === 0) {
          container.innerHTML = '<p style="color: var(--muted); font-style: italic; margin: 8px 0;">No hay proformas guardadas</p>';
          return;
        }

        container.innerHTML = saved.map(proforma => `
          <div class="saved-item">
            <strong>${proforma.number}</strong><br>
            <small style="color: var(--muted);">${proforma.client.name}</small><br>
            <small style="color: var(--muted);">${new Date(proforma.timestamp).toLocaleDateString('es-PE')}</small>
            <div class="actions-small">
              <button class="btn-small btn--primary" onclick="manager.loadProforma('${proforma.number}')">Cargar</button>
              <button class="btn-small" onclick="manager.duplicateProforma('${proforma.number}')">Duplicar</button>
              <button class="btn-small" onclick="manager.deleteProforma('${proforma.number}')">Eliminar</button>
            </div>
          </div>
        `).join('');
      }

      loadProforma(number) {
        const saved = this.getSavedProformas();
        const proforma = saved.find(p => p.number === number);
        
        if (proforma) {
          this.fillFormData(proforma);
          this.toggleManagement();
          ToastManager.show('Datos cargados desde el historial', 'success', `Proforma ${number}`);
        }
      }

      duplicateProforma(number) {
        const saved = this.getSavedProformas();
        const proforma = saved.find(p => p.number === number);
        
        if (proforma) {
          const newProforma = { ...proforma };
          newProforma.number = this.generateProformaNumber();
          newProforma.timestamp = new Date().toISOString();
          
          this.fillFormData(newProforma);
          this.toggleManagement();
          ToastManager.show(`Copia creada con nuevo n√∫mero`, 'success', `Duplicada como ${newProforma.number}`);
        }
      }

      deleteProforma(number) {
        if (this.confirmAction(`¬øEliminar la proforma ${number}?`, 'Esta acci√≥n no se puede deshacer')) {
          const saved = this.getSavedProformas();
          const filtered = saved.filter(p => p.number !== number);
          localStorage.setItem(this.getStorageKey(), JSON.stringify(filtered));
          this.loadSavedProformas();
          ToastManager.show('Proforma eliminada del historial', 'success', `${number} eliminada`);
        }
      }

      updatePriceSummary() {
        const prices = [];
        document.querySelectorAll('.price[contenteditable]').forEach(cell => {
          const price = cell.textContent.trim();
          if (price && !isNaN(parseFloat(price))) {
            prices.push(`S/ ${price}`);
          }
        });
        document.getElementById('price-summary').textContent = prices.join(' ¬∑ ');
      }

      exportData() {
        const saved = this.getSavedProformas();
        const profile = this.userProfiles[this.currentUser];
        const dataStr = JSON.stringify(saved, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${this.currentUser}-proformas-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        ToastManager.show('Archivo descargado correctamente', 'success', `Proformas de ${profile.name} exportadas`);
      }

      importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
              localStorage.setItem(this.getStorageKey(), JSON.stringify(data));
              this.loadSavedProformas();
              const profile = this.userProfiles[this.currentUser];
              ToastManager.show(`${data.length} proformas cargadas correctamente`, 'success', `Importadas para ${profile.name}`);
            } else {
              ToastManager.show('El archivo no tiene el formato correcto', 'error', 'Formato inv√°lido');
            }
          } catch (error) {
            ToastManager.show('No se pudo leer el archivo seleccionado', 'error', 'Error de lectura');
          }
        };
        reader.readAsText(file);
      }

      autoSave() {
        // Auto-guardar cada 30 segundos si hay cambios
        let lastSave = Date.now();
        setInterval(() => {
          const currentData = JSON.stringify(this.collectFormData());
          if (this.currentProforma !== currentData) {
            this.currentProforma = currentData;
            // Solo auto-guardar si tiene n√∫mero de proforma v√°lido
            const number = document.getElementById('pf-number').textContent;
            const prefixes = ['TAT', 'KIK', 'CAR', 'PRO'];
            if (number && prefixes.some(prefix => number.startsWith(prefix))) {
              // Auto-save silencioso
              console.log(`Auto-guardado realizado para ${this.currentUser}`);
            }
          }
        }, 30000);
      }

      confirmAction(title, message) {
        // Por ahora usar confirm nativo, pero podr√≠as crear un modal elegante
        return confirm(`${title}\n\n${message}`);
      }
    }

    // Inicializar el sistema
    const manager = new ProformaManager();
    
    // Hacer disponible globalmente para los botones inline
    window.manager = manager;
  </script>
</body>
</html>
