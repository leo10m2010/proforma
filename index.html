<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proforma ‚Äî Tato</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÑ</text></svg>">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Pantalla de Login -->
  <div class="login-screen" id="login-screen">
    <div class="login-card">
      <h1>üöÄ Proforma Manager</h1>
      <p>Selecciona tu perfil e ingresa tu PIN para acceder</p>
      
      <div class="user-selection" id="user-selection">
        <div class="user-option" data-user="tato">
          <div class="user-avatar">T</div>
          <div class="user-info">
            <h3>Tato</h3>
            <p>Soluciones Web Profesionales</p>
          </div>
        </div>
        
        <div class="user-option" data-user="kike">
          <div class="user-avatar" style="background: #10b981;">K</div>
          <div class="user-info">
            <h3>Kike</h3>
            <p>Desarrollo y Consultor√≠a</p>
          </div>
        </div>
        
        <div class="user-option" data-user="carlos">
          <div class="user-avatar" style="background: #f59e0b;">C</div>
          <div class="user-info">
            <h3>Carlos</h3>
            <p>Dise√±o y Marketing Digital</p>
          </div>
        </div>
      </div>
      
      <input type="password" class="pin-input" id="login-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
      
      <div class="login-actions">
        <button class="btn-login primary" id="btn-login" disabled>üîê Conectar</button>
        <button class="btn-login secondary" id="btn-offline">üì± Trabajar Sin Conexi√≥n</button>
      </div>
      
      <div class="offline-notice" id="offline-notice" style="display: none;">
        Sin conexi√≥n a internet. Podr√°s sincronizar cuando vuelvas a estar en l√≠nea.
      </div>
    </div>
  </div>

  <div class="page" id="doc" style="display: none;">
    <header>
      <div class="brand">
        <picture class="logo">
          <source type="image/webp" srcset="https://res.cloudinary.com/renatoez/image/upload/v1755882448/Untitled_qmza6o.svg" />
          <img id="logo" alt="Logo Tato" decoding="async" loading="eager" src="https://res.cloudinary.com/renatoez/image/upload/v1755882448/Untitled_qmza6o.svg" />
        </picture>
        <div>
          <small>Soluciones Web Profesionales</small>
        </div>
      </div>
      <div class="titlebox">
        <h2>Proforma</h2>
        <span class="badge">Documento no fiscal</span>
      </div>
    </header>



    <!-- Panel de Usuario Moderno -->
    <div class="modern-user-panel">
      <div class="user-profile-card">
        <div class="user-avatar-section">
          <div class="user-avatar-display" id="current-user-avatar">T</div>
          <div class="user-details">
            <h3 class="user-name" id="current-user-name">Tato</h3>
            <p class="user-role" id="current-user-role">Soluciones Web Profesionales</p>
          </div>
        </div>
        
        <div class="user-actions">
          <button class="action-btn config-btn" id="config-profile" title="Configurar Perfil">
            <span class="btn-icon">‚öôÔ∏è</span>
            <span class="btn-text">Configurar</span>
          </button>
          <button class="action-btn switch-btn" id="switch-user" title="Cambiar Usuario">
            <span class="btn-icon">üîÑ</span>
            <span class="btn-text">Cambiar</span>
          </button>
          <button class="action-btn logout-btn" id="logout-main" title="Cerrar Sesi√≥n">
            <span class="btn-icon">üö™</span>
            <span class="btn-text">Salir</span>
          </button>
        </div>
      </div>
      
      <div class="user-stats">
        <div class="stat-item">
          <span class="stat-number" id="user-proformas-count">0</span>
          <span class="stat-label">Proformas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="user-last-activity">Hoy</span>
          <span class="stat-label">√öltima actividad</span>
        </div>
      </div>
    </div>

    <!-- Panel de Cambio de Usuario -->
    <div class="user-switch-panel" id="user-switch-panel">
      <div class="switch-header">
        <h3>Cambiar Usuario</h3>
        <button class="close-btn" id="close-switch">&times;</button>
      </div>
      <div class="users-grid">
        <div class="user-card" data-user="tato">
          <div class="card-avatar">T</div>
          <div class="card-info">
            <h4>Tato</h4>
            <p>Soluciones Web Profesionales</p>
          </div>
          <div class="card-badge">Activo</div>
        </div>
        <div class="user-card" data-user="kike">
          <div class="card-avatar" style="background: #6b7280;">K</div>
          <div class="card-info">
            <h4>Kike</h4>
            <p>Desarrollo y Consultor√≠a</p>
          </div>
        </div>
        <div class="user-card" data-user="carlos">
          <div class="card-avatar" style="background: #9ca3af;">C</div>
          <div class="card-info">
            <h4>Carlos</h4>
            <p>Dise√±o y Marketing Digital</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Configuraci√≥n Redise√±ado -->
    <div class="modern-profile-panel" id="profile-panel">
      <div class="profile-container">
        <!-- Header con Vista Previa -->
        <div class="config-header">
          <div class="config-title">
            <h2>‚ú® Configuraci√≥n de Perfil</h2>
            <p>Personaliza tu perfil profesional</p>
          </div>
          <button class="close-config" id="cancel-profile">&times;</button>
        </div>

        <div class="config-content">
          <!-- Vista Previa en Tiempo Real -->
          <div class="profile-preview">
            <h3>Vista Previa</h3>
            <div class="preview-card">
              <div class="preview-logo">
                <img id="preview-logo-img" src="" alt="Logo" style="display: none;">
                <div class="preview-avatar" id="preview-avatar">T</div>
              </div>
              <div class="preview-info">
                <h4 id="preview-name">Nombre de la Empresa</h4>
                <p id="preview-tagline">Tu tagline aparecer√° aqu√≠</p>
                <div class="preview-contact">
                  <span id="preview-email">üìß email@ejemplo.com</span>
                  <span id="preview-phone">üì± +51 999 999 999</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Formulario Dividido en Secciones -->
          <div class="config-form">
            <!-- Informaci√≥n B√°sica -->
            <div class="form-section">
              <h4 class="section-title">
                <span class="section-icon">üè¢</span>
                Informaci√≥n de la Empresa
              </h4>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Nombre/Empresa</label>
                  <input type="text" class="form-input" id="profile-name" placeholder="Ej: Tato Solutions">
                  <div class="input-feedback" id="name-feedback"></div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Tagline/Eslogan</label>
                  <input type="text" class="form-input" id="profile-tagline" placeholder="Ej: Soluciones Web Profesionales">
                  <div class="input-feedback" id="tagline-feedback"></div>
                </div>
              </div>
            </div>

            <!-- Informaci√≥n de Contacto -->
            <div class="form-section">
              <h4 class="section-title">
                <span class="section-icon">üìû</span>
                Informaci√≥n de Contacto
              </h4>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Email Profesional</label>
                  <input type="email" class="form-input" id="profile-email" placeholder="contacto@ejemplo.com">
                  <div class="input-feedback" id="email-feedback"></div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Tel√©fono/WhatsApp</label>
                  <input type="text" class="form-input" id="profile-phone" placeholder="+51 975 212 132">
                  <div class="input-feedback" id="phone-feedback"></div>
                </div>
              </div>
            </div>

            <!-- Imagen y Branding -->
            <div class="form-section">
              <h4 class="section-title">
                <span class="section-icon">üé®</span>
                Imagen y Branding
              </h4>
              
              <div class="logo-upload-section">
                <div class="form-group">
                  <label class="form-label">URL del Logo</label>
                  <div class="logo-input-group">
                    <input type="url" class="form-input" id="profile-logo" placeholder="https://mi-logo.com/logo.svg">
                    <button type="button" class="test-logo-btn" id="test-logo">Probar</button>
                  </div>
                  <div class="input-feedback" id="logo-feedback"></div>
                  <div class="logo-help">
                    <span class="help-icon">üí°</span>
                    <span>Usa Cloudinary, Imgur o cualquier URL p√∫blica de imagen</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Seguridad -->
            <div class="form-section">
              <h4 class="section-title">
                <span class="section-icon">üîê</span>
                Seguridad y Acceso
              </h4>
              
              <div class="pin-section">
                <div class="form-group">
                  <label class="form-label">PIN de Acceso (4 d√≠gitos)</label>
                  <div class="pin-inputs">
                    <input type="password" class="pin-input" id="profile-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
                    <input type="password" class="pin-input" id="profile-pin-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
                  </div>
                  <div class="input-feedback" id="pin-feedback"></div>
                  <div class="pin-help">
                    <span class="help-icon">üîí</span>
                    <span>Tu PIN personal para acceder a este perfil</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones del Footer -->
        <div class="config-footer">
          <button class="btn-config secondary" id="reset-profile">
            <span class="btn-icon">üîÑ</span>
            Resetear
          </button>
          <div class="main-actions">
            <button class="btn-config secondary" id="cancel-profile-alt">
              <span class="btn-icon">‚úñ</span>
              Cancelar
            </button>
            <button class="btn-config primary" id="save-profile">
              <span class="btn-icon">üíæ</span>
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="management-panel" id="management-panel">
      <h3 style="margin: 0 0 8px; font-size: 14px;">üìÅ Gesti√≥n de Proformas</h3>
      <div class="actions">
        <button class="btn btn--success" id="save-proforma">üíæ Guardar</button>
        <button class="btn btn--warning" id="new-proforma">üìÑ Nueva</button>
        <button class="btn" id="export-data">üì§ Exportar Datos</button>
        <button class="btn" id="import-data">üì• Importar Datos</button>
        <button class="btn btn--warning" id="reset-profiles">üîÑ Resetear Perfiles</button>
        <input type="file" id="import-file" accept=".json" style="display: none;">
      </div>
      <div class="saved-proformas" id="saved-proformas">
        <!-- Las proformas guardadas aparecer√°n aqu√≠ -->
      </div>
    </div>

    <section class="grid-2">
      <div class="panel">
        <h3>Datos de la Proforma</h3>
        <div class="kv">
          <strong>N¬∫ Proforma</strong><span id="pf-number">PRO-2025-001</span>
          <strong>Fecha</strong><span id="pf-date">‚Äî</span>
          <strong>Validez</strong><span>15 d√≠as calendario</span>
        </div>
      </div>
      <div class="panel">
        <h3>Datos del Cliente</h3>
        <div class="kv">
          <strong>Cliente</strong><span contenteditable="true">[Nombre / Empresa]</span>
          <strong>Contacto</strong><span contenteditable="true">[Correo] ¬∑ [Tel/WhatsApp]</span>
          <strong>RUC / ID</strong><span contenteditable="true">[Opcional]</span>
        </div>
      </div>
    </section>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
      <h3 class="section-title" style="margin: 0;">Opciones de desarrollo web</h3>
      <button class="btn btn--success" id="add-option" style="font-size: 11px; padding: 4px 8px;">+ Agregar Opci√≥n</button>
    </div>
    <table id="options-table">
      <thead>
        <tr>
          <th>Opci√≥n</th>
          <th>Descripci√≥n</th>
          <th class="price">Precio (S/)</th>
          <th style="width: 40px;">Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="options-tbody">
        <tr data-option-id="1">
          <td contenteditable="true">Opci√≥n 1 ‚Äî WordPress</td>
          <td class="incl" contenteditable="true">‚Ä¢ Dise√±o personalizado y responsive.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculado a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Capacitaci√≥n b√°sica.</td>
          <td class="price" contenteditable="true">2,000.00</td>
          <td><button class="btn-small" onclick="manager.removeOption(1)" style="background: #ef4444; color: white; border: none;">√ó</button></td>
        </tr>
        <tr data-option-id="2">
          <td contenteditable="true">Opci√≥n 2 ‚Äî Next.js</td>
          <td class="incl" contenteditable="true">‚Ä¢ Arquitectura moderna con alto rendimiento y SEO t√©cnico.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculada a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Dise√±o moderno y escalable.</td>
          <td class="price" contenteditable="true">3,000.00</td>
          <td><button class="btn-small" onclick="manager.removeOption(2)" style="background: #ef4444; color: white; border: none;">√ó</button></td>
        </tr>
      </tbody>
    </table>

    <div class="cards">
      <div class="card">
        <h4>Incluye</h4>
        <div contenteditable="true">Puesta en producci√≥n ¬∑ Optimizado m√≥viles ¬∑ Capacitaci√≥n b√°sica</div>
      </div>
      <div class="card">
        <h4>No incluye</h4>
        <div contenteditable="true">Hosting y dominio (se cotizan aparte).</div>
      </div>
    </div>

    <div class="totals">
      <div>
        <p><strong>Plazo estimado:</strong> <span contenteditable="true">2‚Äì4 semanas</span>.</p>
        <p contenteditable="true">Los precios incluyen desarrollo e implementaci√≥n. Esta proforma no constituye comprobante de pago.</p>
      </div>
      <div><strong>Opciones:</strong><br><span id="price-summary">S/ 2,000.00 ¬∑ S/ 3,000.00</span></div>
    </div>

    <div class="cta">
      <div>
        <strong>¬øListo para empezar?</strong><br>
        <small>Elige una opci√≥n y coordinemos el inicio.</small>
      </div>
      <a id="cta-wsp" href="https://wa.me/51975212132" target="_blank">WhatsApp</a>
    </div>

    <div class="actions">
      <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
      <button class="btn btn--primary" id="fill-demo">üéØ Rellenar demo</button>
      <button class="btn" id="toggle-management">üìÅ Gestionar Proformas</button>
    </div>

    <footer>
      <div>
        ¬© <span id="year"></span> Tato ¬∑ renato.espinoza.medrano@gmail.com ¬∑ +51 975 212 132
      </div>
      <div>
        Gracias por considerar a Tato ‚ù§Ô∏è
      </div>
    </footer>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirmar acci√≥n</div>
      <div class="modal-message" id="modal-message">¬øEst√°s seguro?</div>
      <div class="modal-actions">
        <button class="modal-btn" id="modal-cancel">Cancelar</button>
        <button class="modal-btn modal-btn--danger" id="modal-confirm">Confirmar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Configuraci√≥n de Supabase
    // NOTA: Estas claves son seguras para uso p√∫blico
    // Las pol√≠ticas RLS protegen tus datos privados
    const SUPABASE_URL = 'https://zenywgqwuzofmswilwyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inplbnl3Z3F3dXpvZm1zd2lsd3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODc2MTEsImV4cCI6MjA3MTQ2MzYxMX0.dBhAmrtTw2VSMCrL71MgG7_V85Qy-iApL6LFfNFEulc';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Sistema de retry y manejo de errores
    class NetworkManager {
      static async retryOperation(operation, maxRetries = 3, delay = 1000) {
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
          try {
            return await operation();
          } catch (error) {
            console.log(`Intento ${attempt}/${maxRetries} fall√≥:`, error.message);
            
            if (attempt === maxRetries) {
              throw error;
            }
            
            // Delay exponencial: 1s, 2s, 4s
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
          }
        }
      }

      static isNetworkError(error) {
        return error.message.includes('network') || 
               error.message.includes('fetch') ||
               error.message.includes('timeout') ||
               error.code === 'NETWORK_ERROR';
      }

      static async withConnectionCheck(operation) {
        if (!navigator.onLine) {
          throw new Error('Sin conexi√≥n a internet');
        }
        return await operation();
      }
    }

    // Sistema de encriptaci√≥n simple para datos locales
    class CryptoManager {
      static encode(data, key = 'tato-2025') {
        try {
          const str = JSON.stringify(data);
          return btoa(str + '|' + key);
        } catch {
          return data; // Fallback sin encriptar
        }
      }

      static decode(encodedData, key = 'tato-2025') {
        try {
          const decoded = atob(encodedData);
          const [str, storedKey] = decoded.split('|');
          if (storedKey !== key) throw new Error('Invalid key');
          return JSON.parse(str);
        } catch {
          return encodedData; // Fallback para datos no encriptados
        }
      }
    }

    // Sistema de Modal de confirmaci√≥n
    class ModalManager {
      static show(title, message, confirmText = 'Confirmar', type = 'danger') {
        return new Promise((resolve) => {
          const overlay = document.getElementById('modal-overlay');
          const titleEl = document.getElementById('modal-title');
          const messageEl = document.getElementById('modal-message');
          const confirmBtn = document.getElementById('modal-confirm');
          const cancelBtn = document.getElementById('modal-cancel');
          
          titleEl.textContent = title;
          messageEl.textContent = message;
          confirmBtn.textContent = confirmText;
          confirmBtn.className = `modal-btn modal-btn--${type}`;
          
          overlay.classList.add('show');
          
          const handleConfirm = () => {
            overlay.classList.remove('show');
            cleanup();
            resolve(true);
          };
          
          const handleCancel = () => {
            overlay.classList.remove('show');
            cleanup();
            resolve(false);
          };
          
          const cleanup = () => {
            confirmBtn.removeEventListener('click', handleConfirm);
            cancelBtn.removeEventListener('click', handleCancel);
            overlay.removeEventListener('click', handleOverlayClick);
          };
          
          const handleOverlayClick = (e) => {
            if (e.target === overlay) handleCancel();
          };
          
          confirmBtn.addEventListener('click', handleConfirm);
          cancelBtn.addEventListener('click', handleCancel);
          overlay.addEventListener('click', handleOverlayClick);
        });
      }
    }

    // Sistema de Toast Notifications
    class ToastManager {
      static show(message, type = 'info', title = '', duration = 5000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        
        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            ${title ? `<div class="toast-title">${title}</div>` : ''}
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;
        
        container.appendChild(toast);
        
        // Animaci√≥n de entrada
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto-remover
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // Sistema de gesti√≥n de proformas multi-usuario con Supabase
    class ProformaManager {
      constructor() {
        this.currentUser = 'tato';
        this.currentProforma = null;
        this.userProfiles = this.getDefaultProfiles();
        this.isOnline = false;
        this.currentSupabaseUser = null;
        this.syncQueue = [];
        this.pendingSync = []; // Cola de sincronizaci√≥n offline
        this.selectedLoginUser = null; // Usuario seleccionado en login
        this.eventsInitialized = false; // Flag para evitar eventos duplicados
        // No llamar init() aqu√≠ - se llama desde la carga de la p√°gina
      }

      getDefaultProfiles() {
        return {
          tato: {
            name: 'Tato',
            tagline: 'Soluciones Web Profesionales',
            email: 'renato.espinoza.medrano@gmail.com',
            phone: '+51 975 212 132',
            logo: 'https://res.cloudinary.com/renatoez/image/upload/v1755882448/Untitled_qmza6o.svg',
            pin: '1234' // PIN por defecto
          },
          kike: {
            name: 'Kike',
            tagline: 'Desarrollo Web & Dise√±o',
            email: 'kike@ejemplo.com',
            phone: '+51 999 888 777',
            logo: '',
            pin: '5678' // PIN por defecto
          },
          carlos: {
            name: 'Carlos',
            tagline: 'Soluciones Digitales',
            email: 'carlos@ejemplo.com',
            phone: '+51 888 777 666',
            logo: '',
            pin: '9012' // PIN por defecto
          }
        };
      }

      getStorageKey(type = 'proformas') {
        return `${this.currentUser}-${type}`;
      }

      generateSimpleUUID(username, pin) {
        // Generar un UUID determin√≠stico basado en username y pin
        const str = `${username}-${pin}`;
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32bit integer
        }
        
        // Convertir a formato UUID v√°lido
        const hex = Math.abs(hash).toString(16).padStart(8, '0');
        return `${hex.slice(0,8)}-${hex.slice(0,4)}-4${hex.slice(0,3)}-a${hex.slice(0,3)}-${hex.slice(0,12)}`.padEnd(36, '0');
      }

      async init() {
        console.log('üöÄ Iniciando ProformaManager...');
        
        this.loadUserProfiles();
        this.loadPendingSync(); // Cargar cola de sincronizaci√≥n
        this.setupLogoFallback();
        this.bindEvents();
        this.setupConnectionMonitoring(); // Nuevo: monitoreo de conexi√≥n
        this.setupKeyboardShortcuts(); // Atajos de teclado para cambio de usuario
        
        // Mostrar pantalla de login al inicio
        this.showLoginScreen();
        
        // Auto-guardar cada 30 segundos
        setInterval(() => this.autoSave(), 30000);
        
        console.log('‚úÖ ProformaManager iniciado correctamente');
      }

      loadPendingSync() {
        const pending = localStorage.getItem('pending-sync');
        if (pending) {
          this.pendingSync = JSON.parse(pending);
          if (this.pendingSync.length > 0) {
            ToastManager.show(`${this.pendingSync.length} cambios pendientes de sincronizar`, 'info', 'Sincronizaci√≥n pendiente');
          }
        }
      }

      setupConnectionMonitoring() {
        // Detectar cuando regresa la conexi√≥n
        window.addEventListener('online', () => {
          ToastManager.show('Conexi√≥n restaurada. Sincronizando...', 'info', 'Conexi√≥n restaurada');
          this.syncPendingData();
        });

        window.addEventListener('offline', () => {
          ToastManager.show('Sin conexi√≥n. Guardando localmente', 'warning', 'Modo offline');
          this.isOnline = false;
          this.updateSyncStatus('offline', 'Sin conexi√≥n');
        });

        // Verificar conexi√≥n peri√≥dicamente
        setInterval(() => {
          if (navigator.onLine && !this.isOnline) {
            this.syncPendingData();
          }
        }, 30000); // Cada 30 segundos
      }

      async syncPendingData() {
        if (this.pendingSync.length === 0) return;

        try {
          ToastManager.show(`Sincronizando ${this.pendingSync.length} cambios...`, 'info', 'Sincronizaci√≥n autom√°tica');
          
          for (const item of this.pendingSync) {
            if (item.type === 'proforma') {
              await this.syncProformaToSupabase(item.data);
            } else if (item.type === 'profile') {
              await this.syncProfileToSupabase();
            }
          }
          
          this.pendingSync = [];
          localStorage.removeItem('pending-sync');
          ToastManager.show('Todos los cambios sincronizados', 'success', 'Sincronizaci√≥n completa');
          
        } catch (error) {
          ToastManager.show('Error en sincronizaci√≥n autom√°tica', 'error', 'Error de sincronizaci√≥n');
        }
      }

      async checkSupabaseAuth() {
        try {
          // Verificar conexi√≥n b√°sica a Supabase
          await supabase.from('user_profiles').select('id').limit(1);
          console.log('Conexi√≥n a Supabase verificada');
        } catch (error) {
          console.log('Sin conexi√≥n a Supabase, trabajando offline');
          this.updateSyncStatus('offline', 'Trabajando sin conexi√≥n');
        }
      }

      updateAuthUI() {
        // Panel de autenticaci√≥n eliminado - ahora se usa el login principal
        console.log('Auth UI actualizada - usuario:', this.currentSupabaseUser ? 'conectado' : 'desconectado');
      }

      updateSyncStatus(status, text, details = '') {
        // Sync status simplificado - solo para logs
        console.log(`Sync Status: ${status} - ${text}`, details ? `(${details})` : '');
      }

      loadUserProfiles() {
        try {
          const saved = localStorage.getItem('user-profiles');
          if (saved) {
            const decoded = CryptoManager.decode(saved);
            const profiles = typeof decoded === 'string' ? JSON.parse(decoded) : decoded;
            
            // Validar estructura de datos
            if (this.validateProfiles(profiles)) {
              this.userProfiles = { ...this.getDefaultProfiles(), ...profiles };
            } else {
              console.warn('Perfiles corruptos, usando por defecto');
              this.userProfiles = this.getDefaultProfiles();
            }
          }
        } catch (error) {
          console.error('Error cargando perfiles:', error);
          this.userProfiles = this.getDefaultProfiles();
          ToastManager.show('Perfiles restaurados a valores por defecto', 'warning', 'Datos corruptos');
        }
      }

      saveUserProfiles() {
        try {
          const encoded = CryptoManager.encode(this.userProfiles);
          localStorage.setItem('user-profiles', encoded);
          
          // Crear backup autom√°tico
          this.createBackup('profiles', this.userProfiles);
        } catch (error) {
          console.error('Error guardando perfiles:', error);
          ToastManager.show('Error al guardar configuraci√≥n', 'error', 'Error de almacenamiento');
        }
      }

      validateProfiles(profiles) {
        if (!profiles || typeof profiles !== 'object') return false;
        
        for (const [username, profile] of Object.entries(profiles)) {
          if (!profile.name || !profile.pin || !profile.email) {
            console.warn(`Perfil inv√°lido para ${username}`);
            return false;
          }
        }
        return true;
      }

      loadCurrentUser() {
        const saved = localStorage.getItem('current-user');
        if (saved) {
          this.currentUser = saved;
        }
        document.getElementById('user-select').value = this.currentUser;
      }

      saveCurrentUser() {
        localStorage.setItem('current-user', this.currentUser);
      }



      setCurrentDate() {
        const d = new Date();
        const opts = { year: 'numeric', month: 'long', day: '2-digit' };
        
        const pfDate = document.getElementById('pf-date');
        const yearElement = document.getElementById('year');
        
        if (pfDate) pfDate.textContent = d.toLocaleDateString('es-PE', opts);
        if (yearElement) yearElement.textContent = d.getFullYear();
      }

      setupLogoFallback() {
        const logo = document.getElementById('logo');
        logo && logo.addEventListener('error', () => {
          logo.onerror = null;
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='140' height='40'><rect width='100%' height='100%' fill='%230f172a'/><text x='50%' y='50%' fill='white' font-family='Arial, Helvetica, sans-serif' font-weight='700' font-size='18' text-anchor='middle' dominant-baseline='middle'>Tato</text></svg>`;
          logo.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        });
      }

      bindEvents() {
        // Evitar duplicar eventos
        if (this.eventsInitialized) {
          console.log('Eventos ya inicializados, omitiendo...');
          return;
        }

        console.log('Inicializando eventos...');
        
        // Eventos existentes
        document.getElementById('fill-demo').addEventListener('click', () => this.fillDemo());
        document.getElementById('toggle-management').addEventListener('click', () => this.toggleManagement());
        document.getElementById('save-proforma').addEventListener('click', () => this.saveCurrentProforma());
        document.getElementById('new-proforma').addEventListener('click', () => this.newProforma());
        document.getElementById('export-data').addEventListener('click', () => this.exportData());
        document.getElementById('import-data').addEventListener('click', () => document.getElementById('import-file').click());
        document.getElementById('import-file').addEventListener('change', (e) => this.importData(e));
        document.getElementById('reset-profiles').addEventListener('click', () => this.resetProfiles());
        document.getElementById('add-option').addEventListener('click', () => this.addNewOption());

        // Nuevos eventos de usuario moderno
        // Botones del panel de usuario
        const switchBtn = document.getElementById('switch-user');
        const logoutBtn = document.getElementById('logout-main');
        
        if (switchBtn) {
          switchBtn.addEventListener('click', () => {
            console.log('Bot√≥n Cambiar Usuario clickeado');
            this.showUserSwitcher();
          });
        } else {
          console.error('Bot√≥n switch-user no encontrado');
        }
        
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            console.log('Bot√≥n Salir clickeado');
            this.logout();
          });
        } else {
          console.error('Bot√≥n logout-main no encontrado');
        }
        
        document.getElementById('close-switch').addEventListener('click', () => this.hideUserSwitcher());
        document.getElementById('config-profile').addEventListener('click', () => {
          console.log('‚öôÔ∏è Bot√≥n Configurar clickeado');
          this.toggleProfilePanel();
        });
        const saveBtn = document.getElementById('save-profile');
        if (saveBtn) {
          saveBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('üéØ Save button clicked!');
            await this.saveProfile();
          });
          console.log('‚úÖ Save button event listener attached');
        } else {
          console.error('‚ùå Save button not found!');
        }
        document.getElementById('cancel-profile').addEventListener('click', () => this.toggleProfilePanel());
        document.getElementById('cancel-profile-alt').addEventListener('click', () => this.toggleProfilePanel());
        document.getElementById('test-logo').addEventListener('click', () => this.testLogoUrl());
        document.getElementById('reset-profile').addEventListener('click', () => this.resetCurrentProfile());
        
        // Eventos de cambio de usuario
        document.querySelectorAll('.user-card').forEach(card => {
          card.addEventListener('click', () => {
            const user = card.dataset.user;
            if (user !== this.currentUser) {
              this.switchUser(user);
              this.hideUserSwitcher();
            }
          });
        });

        // Vista previa en tiempo real
        document.getElementById('profile-name').addEventListener('input', () => this.updatePreview());
        document.getElementById('profile-tagline').addEventListener('input', () => this.updatePreview());
        document.getElementById('profile-email').addEventListener('input', () => this.updatePreview());
        document.getElementById('profile-phone').addEventListener('input', () => this.updatePreview());
        document.getElementById('profile-logo').addEventListener('input', () => this.updatePreview());

        // Eventos de autenticaci√≥n eliminados - se usa el nuevo sistema de login
        
        // Permitir login con Enter
        // Eventos del nuevo sistema de login
        this.bindLoginEvents();

        // Auto-actualizar resumen de precios
        document.addEventListener('input', (e) => {
          if (e.target.classList.contains('price')) {
            this.updatePriceSummary();
          }
        });
        
        // Marcar eventos como inicializados
        this.eventsInitialized = true;
        console.log('Eventos inicializados correctamente');
      }

      bindLoginEvents() {
        const userOptions = document.querySelectorAll('.user-option');
        const pinInput = document.getElementById('login-pin');
        const loginBtn = document.getElementById('btn-login');
        const offlineBtn = document.getElementById('btn-offline');
        
        // Selecci√≥n de usuario
        userOptions.forEach(option => {
          option.addEventListener('click', () => {
            console.log('Usuario seleccionado:', option.dataset.user);
            userOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            this.selectedLoginUser = option.dataset.user;
            this.checkLoginForm();
            console.log('selectedLoginUser actualizado:', this.selectedLoginUser);
          });
        });
        
        // Input de PIN
        pinInput.addEventListener('input', () => {
          // Solo permitir n√∫meros
          pinInput.value = pinInput.value.replace(/[^0-9]/g, '');
          this.checkLoginForm();
        });
        
        pinInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !loginBtn.disabled) {
            this.performLogin();
          }
        });
        
        // Botones
        loginBtn.addEventListener('click', () => this.performLogin());
        offlineBtn.addEventListener('click', () => this.performOfflineLogin());
        
        // Cerrar perfil con Escape o click fuera del panel
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            document.getElementById('profile-panel').classList.remove('active');
          }
        });
        
        document.getElementById('cancel-profile').addEventListener('click', () => {
          document.getElementById('profile-panel').classList.remove('active');
        });
      }

      checkLoginForm() {
        const loginBtn = document.getElementById('btn-login');
        const pinInput = document.getElementById('login-pin');
        const hasUser = this.selectedLoginUser;
        const hasPin = pinInput.value.length === 4;
        
        console.log('checkLoginForm - hasUser:', hasUser, 'hasPin:', hasPin);
        loginBtn.disabled = !(hasUser && hasPin);
      }

      async performLogin() {
        const pinInput = document.getElementById('login-pin');
        const pin = pinInput.value;
        
        if (!this.selectedLoginUser || pin.length !== 4) {
          ToastManager.show('Selecciona un usuario e ingresa un PIN v√°lido', 'error', 'Datos incompletos');
          return;
        }
        
        // Cambiar al usuario seleccionado
        this.currentUser = this.selectedLoginUser;
        
        // Simular loading
        const loginBtn = document.getElementById('btn-login');
        const originalText = loginBtn.textContent;
        loginBtn.textContent = 'üîÑ Conectando...';
        loginBtn.disabled = true;
        
        try {
          // Intentar login con PIN
          await this.loginWithPinNew(pin);
          
          // Si llega aqu√≠, el login fue exitoso
          this.hideLoginScreen();
          ToastManager.show(`¬°Bienvenido ${this.userProfiles[this.currentUser].name}!`, 'success', 'Login exitoso');
          
        } catch (error) {
          console.error('Error en login:', error);
          ToastManager.show('PIN incorrecto o error de conexi√≥n', 'error', 'Error de login');
          
          loginBtn.textContent = originalText;
          loginBtn.disabled = false;
        }
      }

      performOfflineLogin() {
        if (!this.selectedLoginUser) {
          ToastManager.show('Selecciona un usuario para trabajar offline', 'warning', 'Usuario requerido');
          return;
        }
        
        this.currentUser = this.selectedLoginUser;
        this.isOnline = false;
        this.hideLoginScreen();
        ToastManager.show(`Trabajando offline como ${this.userProfiles[this.currentUser].name}`, 'info', 'Modo offline');
      }

      hideLoginScreen() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('doc').style.display = 'block';
        this.updateUserInterface();
        this.newProforma(false);
      }

      showLoginScreen() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('doc').style.display = 'none';
        document.getElementById('login-pin').value = '';
        this.selectedLoginUser = null;
        
        // Limpiar selecciones previas
        document.querySelectorAll('.user-option').forEach(opt => opt.classList.remove('selected'));
        
        this.checkLoginForm();
        console.log('Pantalla de login mostrada');
      }

      async loginWithPinNew(pin) {
        const userProfile = this.userProfiles[this.currentUser];
        
        if (!userProfile.pin || userProfile.pin !== pin) {
          throw new Error('PIN incorrecto');
        }
        
        // Intentar conectar a Supabase
        try {
          const { data, error } = await supabase.auth.signInAnonymously();
          
          if (error) throw error;
          
          this.currentSupabaseUser = data.user;
          this.isOnline = true;
          
          // Crear/verificar perfil en Supabase
          await this.createOrVerifyUserProfile(pin);
          
          // Sincronizar datos
          await this.syncFromSupabase();
          
        } catch (error) {
          console.warn('No se pudo conectar a Supabase, trabajando offline:', error);
          this.isOnline = false;
        }
      }

      switchUser(newUser) {
        console.log('üîÄ Cambiando usuario de', this.currentUser, 'a', newUser);
        if (this.currentUser !== newUser) {
          this.currentUser = newUser;
          this.saveCurrentUser();
          this.updateUserInterface();
          this.loadSavedProformas();
          // Crear nueva proforma para el usuario
          this.newProforma(false); // false = no mostrar confirmaci√≥n
          console.log('‚úÖ Usuario cambiado exitosamente a', newUser);
        }
      }



      async saveProfile() {
        console.log('üíæ Bot√≥n Guardar clickeado - iniciando guardado de perfil...');
        const pin = document.getElementById('profile-pin').value;
        const pinConfirm = document.getElementById('profile-pin-confirm').value;
        
        // Validar PIN
        if (pin && pin !== pinConfirm) {
          ToastManager.show('Los PINs no coinciden', 'error', 'Error de validaci√≥n');
          return;
        }
        
        if (pin && (pin.length !== 4 || !/^\d{4}$/.test(pin))) {
          ToastManager.show('El PIN debe tener exactamente 4 d√≠gitos', 'error', 'PIN inv√°lido');
          return;
        }

        const profile = {
          name: document.getElementById('profile-name').value,
          tagline: document.getElementById('profile-tagline').value,
          email: document.getElementById('profile-email').value,
          phone: document.getElementById('profile-phone').value,
          logo: document.getElementById('profile-logo').value,
          pin: pin || this.userProfiles[this.currentUser].pin // Mantener PIN anterior si no se cambia
        };

        this.userProfiles[this.currentUser] = profile;
        this.saveUserProfiles();
        this.updateUserInterface();
        this.toggleProfilePanel();
        
        console.log('Perfil guardado localmente:', profile);
        console.log('Usuario actual:', this.currentUser);
        console.log('Logo actualizado:', profile.logo);
        
        if (pin && pin !== this.userProfiles[this.currentUser].pin) {
          ToastManager.show('PIN actualizado correctamente', 'success', `Perfil de ${profile.name}`);
        } else {
          ToastManager.show('Configuraci√≥n actualizada', 'success', `Perfil de ${profile.name}`);
        }
        
        // Sincronizar perfil con Supabase si est√° conectado
        if (this.isOnline && this.currentSupabaseUser) {
          await this.syncProfileToSupabase();
          ToastManager.show('Perfil sincronizado con la nube', 'success', 'Sincronizaci√≥n completa');
        } else {
          // Agregar a cola de sincronizaci√≥n
          this.pendingSync.push({ type: 'profile', data: profile });
          localStorage.setItem('pending-sync', JSON.stringify(this.pendingSync));
          ToastManager.show('Se sincronizar√° cuando tengas conexi√≥n', 'info', 'Guardado local');
        }
      }

      async loginWithPin() {
        const pin = document.getElementById('user-pin').value;
        const userProfile = this.userProfiles[this.currentUser];
        
        if (!pin) {
          ToastManager.show('Por favor ingresa tu PIN', 'warning', 'PIN requerido');
          return;
        }

        if (pin !== userProfile.pin) {
          ToastManager.show('PIN incorrecto para este usuario', 'error', 'Acceso denegado');
          document.getElementById('user-pin').value = '';
          return;
        }

        try {
          this.updateSyncStatus('sync', 'Conectando...');
          
          // Intentar autenticaci√≥n an√≥nima con retry
          let authData = null;
          
          try {
            authData = await NetworkManager.retryOperation(async () => {
              return await NetworkManager.withConnectionCheck(async () => {
                const result = await supabase.auth.signInAnonymously();
                if (result.error) {
                  throw new Error(result.error.message);
                }
                return result.data;
              });
            });
            console.log('Autenticaci√≥n an√≥nima exitosa');
          } catch (authError) {
            console.log('Autenticaci√≥n an√≥nima no disponible, usando modo simple');
            // Generar un ID √∫nico pero determin√≠stico
            authData = {
              user: {
                id: this.generateSimpleUUID(this.currentUser, pin),
                isSimpleAuth: true
              }
            };
          }

          this.currentSupabaseUser = authData.user;
          this.isOnline = true;
          
          // Solo crear perfil si tenemos autenticaci√≥n real
          if (!this.currentSupabaseUser.isSimpleAuth) {
            await this.createOrVerifyUserProfile(pin);
          }
          
          this.updateAuthUI();
          await this.syncFromSupabase();
          ToastManager.show('Datos sincronizados desde la nube', 'success', '¬°Conectado exitosamente!');

        } catch (error) {
          console.error('Error de conexi√≥n:', error);
          ToastManager.show('Trabajando en modo offline por ahora', 'warning', 'Conexi√≥n limitada');
          this.updateSyncStatus('offline', 'Modo offline');
        }
      }

      async hashPin(pin) {
        // Crear hash SHA-256 del PIN con salt
        const salt = 'proforma-salt-2024';
        const encoder = new TextEncoder();
        const data = encoder.encode(pin + salt);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      async createOrVerifyUserProfile(pin) {
        try {
          // Hashear el PIN localmente para seguridad
          const hashedPin = await this.hashPin(pin);
          
          // Intentar crear/actualizar el perfil de usuario
          const { error } = await supabase
            .from('user_profiles')
            .upsert({
              user_id: this.currentSupabaseUser.id,
              username: this.currentUser,
              pin_hash: hashedPin,
              profile_data: this.userProfiles[this.currentUser]
            }, { 
              ignoreDuplicates: true 
            });

          if (error) {
            console.log('Error al crear/actualizar perfil (no cr√≠tico):', error.message);
            // No lanzar error, continuar funcionando
          }

          console.log('Perfil de usuario verificado/creado');
        } catch (error) {
          console.error('Error verificando perfil:', error);
          throw new Error('Error al verificar usuario');
        }
      }

      async logout() {
        const confirmed = await ModalManager.show(
          'Cerrar Sesi√≥n', 
          '¬øEst√°s seguro de que quieres salir? Se guardar√° tu trabajo.', 
          'Salir', 
          'warning'
        );
        
        if (confirmed) {
          try {
            // Guardar trabajo actual
            this.saveCurrentProforma();
            
            // Cerrar sesi√≥n de Supabase
            await supabase.auth.signOut();
            
            // Limpiar autenticaci√≥n
            this.currentSupabaseUser = null;
            this.isOnline = false;
            this.selectedLoginUser = null;
            
            // Mostrar pantalla de login
            this.showLoginScreen();
            
            ToastManager.show('Sesi√≥n cerrada correctamente', 'success', 'Hasta pronto');
          } catch (error) {
            console.error('Error al desconectar:', error);
            ToastManager.show('Error al cerrar sesi√≥n', 'error', 'Error');
          }
        }
      }

      workOffline() {
        // M√©todo simplificado - panel auth eliminado
        ToastManager.show('Los datos se guardan localmente en tu navegador', 'info', 'Modo sin conexi√≥n');
      }

      async syncFromSupabase() {
        if (!this.isOnline || !this.currentSupabaseUser) return;

        try {
          this.updateSyncStatus('sync', 'Sincronizando...');

          // Crear tablas si no existen
          await this.createTablesIfNeeded();

          // Sincronizar perfiles
          await this.syncProfileFromSupabase();
          
          // Sincronizar proformas
          await this.syncProformasFromSupabase();

          this.updateSyncStatus('online', 'Sincronizado');
          
        } catch (error) {
          console.error('Error de sincronizaci√≥n:', error);
          this.updateSyncStatus('error', 'Error de sincronizaci√≥n');
        }
      }

      async createTablesIfNeeded() {
        try {
          // Verificar si las tablas existen haciendo una consulta simple
          await supabase.from('user_profiles').select('id').limit(1);
          await supabase.from('proformas').select('id').limit(1);
          console.log('Tablas verificadas correctamente');
        } catch (error) {
          console.log('Tablas no encontradas. Se crear√°n autom√°ticamente al guardar datos.');
          // Las tablas se crear√°n autom√°ticamente en el primer INSERT
        }
      }

      async syncProfileToSupabase() {
        console.log('üîÑ Iniciando sincronizaci√≥n de perfil...');
        console.log('Online:', this.isOnline);
        console.log('Usuario Supabase:', this.currentSupabaseUser?.id);
        console.log('Perfil a sincronizar:', this.userProfiles[this.currentUser]);
        
        if (!this.isOnline || !this.currentSupabaseUser) {
          console.log('‚ùå No se puede sincronizar - sin conexi√≥n o usuario');
          return;
        }

        try {
          await NetworkManager.retryOperation(async () => {
            // Primero intentar actualizar
            const { error: updateError } = await supabase
              .from('user_profiles')
              .update({
                profile_data: this.userProfiles[this.currentUser],
                updated_at: new Date().toISOString()
              })
              .eq('user_id', this.currentSupabaseUser.id);

            if (updateError) {
              // Si falla update, intentar insertar (puede no existir el perfil)
              const { error: insertError } = await supabase
                .from('user_profiles')
                .insert({
                  user_id: this.currentSupabaseUser.id,
                  username: this.currentUser,
                  pin_hash: 'updated_via_ui', // Placeholder, el PIN real ya est√° hasheado
                  profile_data: this.userProfiles[this.currentUser]
                });

              if (insertError && !insertError.message.includes('duplicate')) {
                throw new Error(`Error al sincronizar perfil: ${insertError.message}`);
              }
            }
          });
          
          console.log('‚úÖ Perfil sincronizado exitosamente con Supabase');
          console.log('Datos enviados:', this.userProfiles[this.currentUser]);
          this.updateSyncStatus('online', 'Sincronizado', 'Perfil actualizado en la nube');
        } catch (error) {
          console.error('Error sincronizando perfil despu√©s de reintentos:', error);
          this.updateSyncStatus('error', 'Error de sincronizaci√≥n', 'Perfil no sincronizado');
        }
      }

      async syncProfileFromSupabase() {
        if (!this.isOnline || !this.currentSupabaseUser) return;

        try {
          const { data, error } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('user_id', this.currentSupabaseUser.id)
            .maybeSingle();

          if (error) {
            console.log('No se pudo acceder al perfil en la nube:', error.message);
            return;
          }

          if (!data) {
            console.log('Perfil no encontrado en la nube, se crear√° al guardar');
            return;
          }
          
          if (data && data.profile_data) {
            // Merge con datos locales, preservando PINs locales
            const cloudProfile = data.profile_data;
            const localProfile = this.userProfiles[data.username];
            
            if (localProfile) {
              cloudProfile.pin = localProfile.pin; // Preservar PIN local
            }
            
            this.userProfiles[data.username] = cloudProfile;
            this.saveUserProfiles();
            console.log('Perfil sincronizado desde la nube');
          }
        } catch (error) {
          console.error('Error cargando perfil:', error);
          // No mostrar error al usuario, trabajar con datos locales
        }
      }

      async syncProformasFromSupabase() {
        if (!this.isOnline || !this.currentSupabaseUser) return;

        try {
          const { data, error } = await supabase
            .from('proformas')
            .select('proforma_number, proforma_data, created_at')
            .eq('user_id', this.currentSupabaseUser.id)
            .eq('username', this.currentUser)
            .order('created_at', { ascending: false });

          if (error) {
            console.log('Proformas no encontradas en la nube, se crear√°n al guardar');
            return;
          }

          if (data && data.length > 0) {
            const supabaseProformas = data.map(item => item.proforma_data);
            
            // Merge con datos locales (mantener lo m√°s reciente)
            const localProformas = this.getSavedProformas();
            const mergedProformas = this.mergeProformas(localProformas, supabaseProformas);
            
            localStorage.setItem(this.getStorageKey(), JSON.stringify(mergedProformas));
            this.loadSavedProformas();
            console.log(`${data.length} proformas sincronizadas desde la nube`);
          } else {
            console.log('No hay proformas en la nube para este usuario');
          }
        } catch (error) {
          console.error('Error cargando proformas:', error);
          // No mostrar error al usuario, trabajar con datos locales
        }
      }

      mergeProformas(local, cloud) {
        const merged = [...local];
        
        cloud.forEach(cloudProforma => {
          const existingIndex = merged.findIndex(p => p.number === cloudProforma.number);
          
          if (existingIndex >= 0) {
            // Si existe, usar la m√°s reciente basada en timestamp
            const localTimestamp = new Date(merged[existingIndex].timestamp);
            const cloudTimestamp = new Date(cloudProforma.timestamp);
            
            if (cloudTimestamp > localTimestamp) {
              merged[existingIndex] = cloudProforma;
            }
          } else {
            // Si no existe, agregar
            merged.push(cloudProforma);
          }
        });
        
        return merged;
      }

      generateProformaNumber() {
        const year = new Date().getFullYear();
        const saved = this.getSavedProformas();
        const currentYearProformas = saved.filter(p => p.number.includes(year.toString()));
        const nextNumber = String(currentYearProformas.length + 1).padStart(3, '0');
        
        // Prefijo personalizado por usuario
        const prefixes = {
          tato: 'TAT',
          kike: 'KIK', 
          carlos: 'CAR'
        };
        
        const prefix = prefixes[this.currentUser] || 'PRO';
        return `${prefix}-${year}-${nextNumber}`;
      }

      fillDemo() {
        const editables = document.querySelectorAll('[contenteditable]');
        editables[0].textContent = 'Comercial Andina SAC';
        editables[1].textContent = 'compras@comercialandina.pe ¬∑ +51 987 654 321';
        editables[2].textContent = '2060xxxxxxx';
        
        const proformaNumber = this.generateProformaNumber();
        document.getElementById('pf-number').textContent = proformaNumber;

        const profile = this.userProfiles[this.currentUser];
        const msg = encodeURIComponent(`Hola ${profile.name}, estoy interesado en la Proforma ${proformaNumber}. Quiero avanzar con mi sitio web.`);
        const phone = profile.phone.replace(/[\s\-\+]/g, '');
        document.getElementById('cta-wsp').href = `https://wa.me/${phone}?text=${msg}`;
      }

      toggleManagement() {
        const panel = document.getElementById('management-panel');
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) {
          this.loadSavedProformas();
        }
      }

      collectFormData() {
        const data = {
          number: document.getElementById('pf-number').textContent,
          date: document.getElementById('pf-date').textContent,
          client: {
            name: document.querySelectorAll('[contenteditable]')[0].textContent,
            contact: document.querySelectorAll('[contenteditable]')[1].textContent,
            ruc: document.querySelectorAll('[contenteditable]')[2].textContent
          },
          options: [],
          includes: document.querySelectorAll('.card div[contenteditable]')[0].textContent,
          excludes: document.querySelectorAll('.card div[contenteditable]')[1].textContent,
          timeline: document.querySelector('.totals span[contenteditable]').textContent,
          terms: document.querySelector('.totals p[contenteditable]').textContent,
          timestamp: new Date().toISOString()
        };

        // Recoger opciones de la tabla (ahora din√°micas)
        const rows = document.querySelectorAll('#options-tbody tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td[contenteditable]');
          if (cells.length >= 3) {
            data.options.push({
              id: row.getAttribute('data-option-id'),
              name: cells[0].textContent,
              description: cells[1].innerHTML,
              price: cells[2].textContent
            });
          }
        });

        return data;
      }

      fillFormData(data) {
        document.getElementById('pf-number').textContent = data.number;
        
        const editables = document.querySelectorAll('[contenteditable]');
        editables[0].textContent = data.client.name;
        editables[1].textContent = data.client.contact;
        editables[2].textContent = data.client.ruc;

        // Limpiar tabla de opciones y recrear din√°micamente
        const tbody = document.getElementById('options-tbody');
        tbody.innerHTML = '';
        
        data.options.forEach((option, index) => {
          const newRow = document.createElement('tr');
          newRow.setAttribute('data-option-id', option.id || Date.now() + index);
          newRow.innerHTML = `
            <td contenteditable="true">${option.name}</td>
            <td class="incl" contenteditable="true">${option.description}</td>
            <td class="price" contenteditable="true">${option.price}</td>
            <td><button class="btn-small" onclick="manager.removeOption(${option.id || Date.now() + index})" style="background: #ef4444; color: white; border: none;">√ó</button></td>
          `;
          tbody.appendChild(newRow);
        });

        // Llenar otros campos
        document.querySelectorAll('.card div[contenteditable]')[0].textContent = data.includes;
        document.querySelectorAll('.card div[contenteditable]')[1].textContent = data.excludes;
        document.querySelector('.totals span[contenteditable]').textContent = data.timeline;
        document.querySelector('.totals p[contenteditable]').textContent = data.terms;

        this.updatePriceSummary();
      }

      async saveCurrentProforma() {
        const data = this.collectFormData();
        const saved = this.getSavedProformas();
        
        // Verificar si ya existe
        const existingIndex = saved.findIndex(p => p.number === data.number);
        
        if (existingIndex >= 0) {
          saved[existingIndex] = data;
          ToastManager.show(`Cambios guardados correctamente`, 'success', `Proforma ${data.number}`);
        } else {
          saved.push(data);
          ToastManager.show(`Nueva proforma creada y guardada`, 'success', `Proforma ${data.number}`);
        }
        
        // Guardar localmente con validaci√≥n
        this.saveProformas(saved);
        
        // Sincronizar con Supabase si est√° conectado
        if (this.isOnline) {
          await this.syncProformaToSupabase(data);
        } else {
          // Agregar a cola de sincronizaci√≥n offline
          this.pendingSync.push({ type: 'proforma', data: data });
          localStorage.setItem('pending-sync', JSON.stringify(this.pendingSync));
          ToastManager.show('Se sincronizar√° cuando regrese la conexi√≥n', 'info', 'Guardado offline');
        }
        
        this.loadSavedProformas();
      }

      async syncProformaToSupabase(proformaData) {
        if (!this.isOnline || !this.currentSupabaseUser) {
          // Agregar a cola de sincronizaci√≥n si no hay conexi√≥n real
          this.pendingSync.push({ type: 'proforma', data: proformaData });
          localStorage.setItem('pending-sync', JSON.stringify(this.pendingSync));
          return;
        }

        try {
          await NetworkManager.retryOperation(async () => {
            const { error } = await supabase
              .from('proformas')
              .upsert({
                user_id: this.currentSupabaseUser.id,
                username: this.currentUser,
                proforma_number: proformaData.number,
                proforma_data: proformaData
              });

            if (error) {
              throw new Error(`Error Supabase: ${error.message}`);
            }
          });
          
          console.log('Proforma sincronizada con Supabase');
        } catch (error) {
          console.error('Error sincronizando proforma despu√©s de reintentos:', error);
          // Agregar a cola de sincronizaci√≥n en caso de error
          this.pendingSync.push({ type: 'proforma', data: proformaData });
          localStorage.setItem('pending-sync', JSON.stringify(this.pendingSync));
          
          if (NetworkManager.isNetworkError(error)) {
            ToastManager.show('Se sincronizar√° cuando mejore la conexi√≥n', 'warning', 'Conexi√≥n inestable');
          }
        }
      }

      async newProforma(showConfirm = true) {
        if (!showConfirm || await this.confirmAction('¬øCrear nueva proforma?', 'Los cambios no guardados se perder√°n')) {
          // Limpiar todos los campos editables
          document.querySelectorAll('[contenteditable]').forEach(el => {
            if (el.innerHTML.includes('[')) return; // Mantener placeholders
            el.textContent = '';
          });
          
          // Resetear datos
          const proformaNumber = this.generateProformaNumber();
          document.getElementById('pf-number').textContent = proformaNumber;
          this.setCurrentDate();
          
          // Resetear opciones a valores por defecto
          const tbody = document.getElementById('options-tbody');
          tbody.innerHTML = '';
          
          const defaultOptions = [
            {
              id: 1,
              name: 'Opci√≥n 1 ‚Äî WordPress',
              description: '‚Ä¢ Dise√±o personalizado y responsive.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculado a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Capacitaci√≥n b√°sica.',
              price: '2,000.00'
            },
            {
              id: 2,
              name: 'Opci√≥n 2 ‚Äî Next.js',
              description: '‚Ä¢ Arquitectura moderna con alto rendimiento y SEO t√©cnico.<br>‚Ä¢ Integraci√≥n de <strong>formulario de recepci√≥n</strong> vinculada a cuestionario de Facebook.<br>‚Ä¢ <strong>Call to Action a WhatsApp</strong>.<br>‚Ä¢ Dise√±o moderno y escalable.',
              price: '3,000.00'
            }
          ];
          
          defaultOptions.forEach(option => {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-option-id', option.id);
            newRow.innerHTML = `
              <td contenteditable="true">${option.name}</td>
              <td class="incl" contenteditable="true">${option.description}</td>
              <td class="price" contenteditable="true">${option.price}</td>
              <td><button class="btn-small" onclick="manager.removeOption(${option.id})" style="background: #ef4444; color: white; border: none;">√ó</button></td>
            `;
            tbody.appendChild(newRow);
          });
          
          this.updatePriceSummary();
          if (showConfirm) ToastManager.show('Formulario limpio y listo para nueva proforma', 'success', 'Nueva proforma');
        }
      }

      getSavedProformas() {
        try {
          const saved = localStorage.getItem(this.getStorageKey());
          if (!saved) return [];
          
          const decoded = CryptoManager.decode(saved);
          const proformas = typeof decoded === 'string' ? JSON.parse(decoded) : decoded;
          
          // Validar estructura de datos
          if (this.validateProformas(proformas)) {
            return proformas;
          } else {
            console.warn('Proformas corruptas, intentando recuperar backup');
            return this.recoverFromBackup('proformas') || [];
          }
        } catch (error) {
          console.error('Error cargando proformas:', error);
          return this.recoverFromBackup('proformas') || [];
        }
      }

      saveProformas(proformas) {
        try {
          const encoded = CryptoManager.encode(proformas);
          localStorage.setItem(this.getStorageKey(), encoded);
          
          // Crear backup autom√°tico
          this.createBackup('proformas', proformas);
        } catch (error) {
          console.error('Error guardando proformas:', error);
          ToastManager.show('Error al guardar proformas', 'error', 'Error de almacenamiento');
        }
      }

      validateProformas(proformas) {
        if (!Array.isArray(proformas)) return false;
        
        return proformas.every(p => {
          return p.number && p.client && p.options && p.timestamp;
        });
      }

      loadSavedProformas() {
        const saved = this.getSavedProformas();
        const container = document.getElementById('saved-proformas');
        
        if (saved.length === 0) {
          container.innerHTML = '<p style="color: var(--muted); font-style: italic; margin: 8px 0;">No hay proformas guardadas</p>';
          return;
        }

        container.innerHTML = saved.map(proforma => `
          <div class="saved-item">
            <strong>${proforma.number}</strong><br>
            <small style="color: var(--muted);">${proforma.client.name}</small><br>
            <small style="color: var(--muted);">${new Date(proforma.timestamp).toLocaleDateString('es-PE')}</small>
            <div class="actions-small">
              <button class="btn-small btn--primary" onclick="manager.loadProforma('${proforma.number}')">Cargar</button>
              <button class="btn-small" onclick="manager.duplicateProforma('${proforma.number}')">Duplicar</button>
              <button class="btn-small" onclick="manager.deleteProforma('${proforma.number}')">Eliminar</button>
            </div>
          </div>
        `).join('');
      }

      loadProforma(number) {
        const saved = this.getSavedProformas();
        const proforma = saved.find(p => p.number === number);
        
        if (proforma) {
          this.fillFormData(proforma);
          this.toggleManagement();
          ToastManager.show('Datos cargados desde el historial', 'success', `Proforma ${number}`);
        }
      }

      duplicateProforma(number) {
        const saved = this.getSavedProformas();
        const proforma = saved.find(p => p.number === number);
        
        if (proforma) {
          const newProforma = { ...proforma };
          newProforma.number = this.generateProformaNumber();
          newProforma.timestamp = new Date().toISOString();
          
          this.fillFormData(newProforma);
          this.toggleManagement();
          ToastManager.show(`Copia creada con nuevo n√∫mero`, 'success', `Duplicada como ${newProforma.number}`);
        }
      }

      async deleteProforma(number) {
        if (await this.confirmAction(`¬øEliminar la proforma ${number}?`, 'Esta acci√≥n no se puede deshacer')) {
          const saved = this.getSavedProformas();
          const filtered = saved.filter(p => p.number !== number);
          this.saveProformas(filtered);
          this.loadSavedProformas();
          ToastManager.show('Proforma eliminada del historial', 'success', `${number} eliminada`);
        }
      }

      updatePriceSummary() {
        const prices = [];
        document.querySelectorAll('.price[contenteditable]').forEach(cell => {
          const price = cell.textContent.trim();
          if (price && !isNaN(parseFloat(price))) {
            prices.push(`S/ ${price}`);
          }
        });
        document.getElementById('price-summary').textContent = prices.join(' ¬∑ ');
      }

      exportData() {
        const saved = this.getSavedProformas();
        const profile = this.userProfiles[this.currentUser];
        const dataStr = JSON.stringify(saved, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${this.currentUser}-proformas-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        ToastManager.show('Archivo descargado correctamente', 'success', `Proformas de ${profile.name} exportadas`);
      }

      importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
              localStorage.setItem(this.getStorageKey(), JSON.stringify(data));
              this.loadSavedProformas();
              const profile = this.userProfiles[this.currentUser];
              ToastManager.show(`${data.length} proformas cargadas correctamente`, 'success', `Importadas para ${profile.name}`);
            } else {
              ToastManager.show('El archivo no tiene el formato correcto', 'error', 'Formato inv√°lido');
            }
          } catch (error) {
            ToastManager.show('No se pudo leer el archivo seleccionado', 'error', 'Error de lectura');
          }
        };
        reader.readAsText(file);
      }

      autoSave() {
        // Auto-guardar cada 30 segundos si hay cambios
        let lastSave = Date.now();
        setInterval(() => {
          const currentData = JSON.stringify(this.collectFormData());
          if (this.currentProforma !== currentData) {
            this.currentProforma = currentData;
            // Solo auto-guardar si tiene n√∫mero de proforma v√°lido
            const number = document.getElementById('pf-number').textContent;
            const prefixes = ['TAT', 'KIK', 'CAR', 'PRO'];
            if (number && prefixes.some(prefix => number.startsWith(prefix))) {
              // Auto-save silencioso
              console.log(`Auto-guardado realizado para ${this.currentUser}`);
            }
          }
        }, 30000);
      }

      async resetProfiles() {
        if (await ModalManager.show('¬øResetear todos los perfiles?', 'Esto restablecer√° los PINs originales y no se puede deshacer.', 'Resetear', 'danger')) {
          localStorage.removeItem('user-profiles');
          this.userProfiles = this.getDefaultProfiles();
          this.saveUserProfiles();
          this.updateUserInterface();
          ToastManager.show('Perfiles restablecidos a valores por defecto', 'success', 'Perfiles reseteados');
          console.log('Perfiles despu√©s del reset:', this.userProfiles);
        }
      }

      createBackup(type, data) {
        try {
          const timestamp = new Date().toISOString();
          const backupKey = `backup-${type}-${this.currentUser}`;
          const backupData = {
            data: data,
            timestamp: timestamp,
            version: '1.0'
          };
          
          localStorage.setItem(backupKey, JSON.stringify(backupData));
          
          // Mantener solo los √∫ltimos 3 backups
          this.cleanOldBackups(type);
        } catch (error) {
          console.error('Error creando backup:', error);
        }
      }

      recoverFromBackup(type) {
        try {
          const backupKey = `backup-${type}-${this.currentUser}`;
          const backup = localStorage.getItem(backupKey);
          
          if (backup) {
            const backupData = JSON.parse(backup);
            console.log(`Recuperando ${type} desde backup del ${backupData.timestamp}`);
            return backupData.data;
          }
        } catch (error) {
          console.error('Error recuperando backup:', error);
        }
        return null;
      }

      cleanOldBackups(type) {
        try {
          const keys = Object.keys(localStorage);
          const backupKeys = keys.filter(key => key.startsWith(`backup-${type}-${this.currentUser}`));
          
          if (backupKeys.length > 3) {
            backupKeys.sort().slice(0, -3).forEach(key => {
              localStorage.removeItem(key);
            });
          }
        } catch (error) {
          console.error('Error limpiando backups:', error);
        }
      }

      addNewOption() {
        const tbody = document.getElementById('options-tbody');
        const currentOptions = tbody.querySelectorAll('tr').length;
        const newOptionId = Date.now(); // ID √∫nico basado en timestamp
        
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-option-id', newOptionId);
        newRow.innerHTML = `
          <td contenteditable="true">Opci√≥n ${currentOptions + 1} ‚Äî Nueva Opci√≥n</td>
          <td class="incl" contenteditable="true">‚Ä¢ Describe aqu√≠ las caracter√≠sticas de esta opci√≥n.<br>‚Ä¢ A√±ade todos los detalles necesarios.<br>‚Ä¢ Personaliza seg√∫n tus necesidades.</td>
          <td class="price" contenteditable="true">0.00</td>
          <td><button class="btn-small" onclick="manager.removeOption(${newOptionId})" style="background: #ef4444; color: white; border: none;">√ó</button></td>
        `;
        
        tbody.appendChild(newRow);
        this.updatePriceSummary();
        ToastManager.show('Nueva opci√≥n a√±adida', 'success', 'Opci√≥n agregada');
        
        // Focus en el primer campo para editar
        const firstCell = newRow.querySelector('td[contenteditable]');
        if (firstCell) {
          firstCell.focus();
        }
      }

      removeOption(optionId) {
        const row = document.querySelector(`tr[data-option-id="${optionId}"]`);
        if (row) {
          const tbody = document.getElementById('options-tbody');
          const totalRows = tbody.querySelectorAll('tr').length;
          
          if (totalRows <= 1) {
            ToastManager.show('Debe haber al menos una opci√≥n', 'warning', 'Opci√≥n requerida');
            return;
          }
          
          row.remove();
          this.updatePriceSummary();
          this.renumberOptions();
          ToastManager.show('Opci√≥n eliminada', 'success', 'Opci√≥n removida');
        }
      }

      renumberOptions() {
        const rows = document.querySelectorAll('#options-tbody tr');
        rows.forEach((row, index) => {
          const firstCell = row.querySelector('td[contenteditable]');
          if (firstCell) {
            const currentText = firstCell.textContent;
            // Solo renumerar si sigue el patr√≥n "Opci√≥n X ‚Äî"
            if (currentText.match(/^Opci√≥n \d+ ‚Äî/)) {
              firstCell.textContent = currentText.replace(/^Opci√≥n \d+ ‚Äî/, `Opci√≥n ${index + 1} ‚Äî`);
            }
          }
        });
      }

      showUserSwitcher() {
        const panel = document.getElementById('user-switch-panel');
        panel.classList.add('active');
        
        // Marcar usuario activo
        document.querySelectorAll('.user-card').forEach(card => {
          card.classList.remove('active');
          if (card.dataset.user === this.currentUser) {
            card.classList.add('active');
          }
        });
      }

      hideUserSwitcher() {
        document.getElementById('user-switch-panel').classList.remove('active');
      }

      updatePreview() {
        const name = document.getElementById('profile-name').value || 'Nombre de la Empresa';
        const tagline = document.getElementById('profile-tagline').value || 'Tu tagline aparecer√° aqu√≠';
        const email = document.getElementById('profile-email').value || 'email@ejemplo.com';
        const phone = document.getElementById('profile-phone').value || '+51 999 999 999';
        const logoUrl = document.getElementById('profile-logo').value;

        // Actualizar vista previa
        document.getElementById('preview-name').textContent = name;
        document.getElementById('preview-tagline').textContent = tagline;
        document.getElementById('preview-email').textContent = `üìß ${email}`;
        document.getElementById('preview-phone').textContent = `üì± ${phone}`;

        // Mostrar logo si hay URL v√°lida
        const logoImg = document.getElementById('preview-logo-img');
        const logoAvatar = document.getElementById('preview-avatar');
        
        if (logoUrl && this.isValidImageUrl(logoUrl)) {
          logoImg.src = logoUrl;
          logoImg.style.display = 'block';
          logoAvatar.style.display = 'none';
        } else {
          logoImg.style.display = 'none';
          logoAvatar.style.display = 'flex';
          logoAvatar.textContent = name.charAt(0).toUpperCase() || 'T';
        }

        // Validar campos en tiempo real
        this.validateField('profile-name', name);
        this.validateField('profile-email', document.getElementById('profile-email').value);
        this.validateField('profile-phone', document.getElementById('profile-phone').value);
        this.validateField('profile-logo', logoUrl);
      }

      validateField(fieldId, value) {
        const input = document.getElementById(fieldId);
        const feedback = document.getElementById(fieldId.replace('profile-', '') + '-feedback');
        
        input.classList.remove('error', 'success');
        feedback.classList.remove('error', 'success');
        feedback.textContent = '';

        if (!value) return;

        switch(fieldId) {
          case 'profile-name':
            if (value.length < 2) {
              this.showFieldError(input, feedback, 'El nombre debe tener al menos 2 caracteres');
            } else {
              this.showFieldSuccess(input, feedback, '‚úì Nombre v√°lido');
            }
            break;
          
          case 'profile-email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
              this.showFieldError(input, feedback, 'Ingresa un email v√°lido');
            } else {
              this.showFieldSuccess(input, feedback, '‚úì Email v√°lido');
            }
            break;
          
          case 'profile-phone':
            const phoneRegex = /^[\+]?[\d\s\-\(\)]{9,}$/;
            if (!phoneRegex.test(value)) {
              this.showFieldError(input, feedback, 'Ingresa un tel√©fono v√°lido');
            } else {
              this.showFieldSuccess(input, feedback, '‚úì Tel√©fono v√°lido');
            }
            break;
          
          case 'profile-logo':
            if (value && !this.isValidImageUrl(value)) {
              this.showFieldError(input, feedback, 'URL de imagen no v√°lida');
            } else if (value) {
              this.showFieldSuccess(input, feedback, '‚úì URL v√°lida');
            }
            break;
        }
      }

      showFieldError(input, feedback, message) {
        input.classList.add('error');
        feedback.classList.add('error');
        feedback.textContent = message;
      }

      showFieldSuccess(input, feedback, message) {
        input.classList.add('success');
        feedback.classList.add('success');
        feedback.textContent = message;
      }

      isValidImageUrl(url) {
        try {
          new URL(url);
          return /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(url) || url.includes('cloudinary.com') || url.includes('imgur.com');
        } catch {
          return false;
        }
      }

      testLogoUrl() {
        const url = document.getElementById('profile-logo').value;
        const feedback = document.getElementById('logo-feedback');
        
        if (!url) {
          ToastManager.show('Ingresa una URL de logo primero', 'warning', 'URL requerida');
          return;
        }

        // Crear imagen temporal para probar
        const img = new Image();
        img.onload = () => {
          this.showFieldSuccess(document.getElementById('profile-logo'), feedback, '‚úì Logo cargado correctamente');
          this.updatePreview();
          ToastManager.show('Logo v√°lido y cargado', 'success', 'Prueba exitosa');
        };
        img.onerror = () => {
          this.showFieldError(document.getElementById('profile-logo'), feedback, '‚úó No se pudo cargar la imagen');
          ToastManager.show('Error al cargar el logo', 'error', 'URL inv√°lida');
        };
        img.src = url;
      }

      updateUserInterface() {
        console.log('üîÑ Actualizando interfaz para usuario:', this.currentUser);
        // Actualizar el header con informaci√≥n del usuario actual
        const profile = this.userProfiles[this.currentUser];
        console.log('üìù Perfil a aplicar:', profile);
        
        // Actualizar logo
        const logo = document.getElementById('logo');
        const logoSource = document.querySelector('.logo source');
        if (logo && profile.logo) {
          logo.src = profile.logo;
          if (logoSource) logoSource.srcset = profile.logo;
          console.log('üñºÔ∏è Logo actualizado:', profile.logo);
        }

        // Actualizar nombre en el brand (puede ser h1 o texto directo)
        const brandNameElement = document.querySelector('.brand h1') || document.querySelector('.brand div');
        if (brandNameElement) {
          if (brandNameElement.tagName === 'H1') {
            brandNameElement.textContent = profile.name;
          } else {
            // Si no hay h1, buscar o crear la estructura
            brandNameElement.innerHTML = `<h1>${profile.name}</h1><small>${profile.tagline}</small>`;
          }
          console.log('üè∑Ô∏è Nombre actualizado:', profile.name);
        }

        // Actualizar tagline
        const brandDiv = document.querySelector('.brand div small') || document.querySelector('.brand small');
        if (brandDiv) {
          brandDiv.textContent = profile.tagline;
          console.log('üìÑ Tagline actualizado:', profile.tagline);
        }

        // Actualizar footer
        const footerElements = document.querySelectorAll('footer span');
        if (footerElements.length >= 2) {
          footerElements[0].textContent = profile.email;
          footerElements[1].textContent = profile.phone;
          console.log('üìû Footer actualizado:', profile.email, profile.phone);
        }

        // Actualizar enlace de WhatsApp
        this.updateWhatsAppLink();
        
        // Actualizar panel moderno
        this.updateModernUserPanel();
        
        console.log('‚úÖ Interfaz actualizada completamente');
      }

      updateModernUserPanel() {
        const profile = this.userProfiles[this.currentUser];
        
        // Actualizar panel de usuario
        document.getElementById('current-user-avatar').textContent = profile.name.charAt(0).toUpperCase();
        document.getElementById('current-user-name').textContent = profile.name;
        document.getElementById('current-user-role').textContent = profile.tagline;
        
        // Actualizar estad√≠sticas
        const proformas = this.getSavedProformas();
        document.getElementById('user-proformas-count').textContent = proformas.length;
        document.getElementById('user-last-activity').textContent = 'Hoy';
      }

      updateWhatsAppLink() {
        const profile = this.userProfiles[this.currentUser];
        const whatsappElement = document.getElementById('cta-wsp');
        
        if (whatsappElement && profile.phone) {
          // Limpiar el n√∫mero de tel√©fono (remover espacios, guiones, etc.)
          const cleanPhone = profile.phone.replace(/[^\d+]/g, '');
          
          // Crear mensaje personalizado
          const mensaje = `Hola ${profile.name}, me interesa cotizar un proyecto web.`;
          const encodedMessage = encodeURIComponent(mensaje);
          
          // Actualizar el enlace de WhatsApp
          whatsappElement.href = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
          
          console.log('üîó Enlace de WhatsApp actualizado:', whatsappElement.href);
          console.log('üì± Tel√©fono usado:', cleanPhone);
          console.log('üë§ Usuario actual:', profile.name);
        }
      }

      toggleProfilePanel() {
        console.log('üîß Abriendo/cerrando panel de configuraci√≥n...');
        const panel = document.getElementById('profile-panel');
        const isActive = panel.classList.contains('active');
        
        console.log('Panel encontrado:', !!panel);
        console.log('Panel activo antes:', isActive);
        
        if (isActive) {
          panel.classList.remove('active');
          console.log('‚ùå Panel cerrado');
        } else {
          panel.classList.add('active');
          this.loadProfileData();
          this.updatePreview();
          console.log('‚úÖ Panel abierto - datos cargados');
        }
      }

      loadProfileData() {
        const profile = this.userProfiles[this.currentUser];
        document.getElementById('profile-name').value = profile.name;
        document.getElementById('profile-tagline').value = profile.tagline;
        document.getElementById('profile-email').value = profile.email;
        document.getElementById('profile-phone').value = profile.phone;
        document.getElementById('profile-logo').value = profile.logo;
        document.getElementById('profile-pin').value = profile.pin || '';
        document.getElementById('profile-pin-confirm').value = profile.pin || '';
      }

      resetCurrentProfile() {
        const defaults = this.getDefaultProfiles()[this.currentUser];
        document.getElementById('profile-name').value = defaults.name;
        document.getElementById('profile-tagline').value = defaults.tagline;
        document.getElementById('profile-email').value = defaults.email;
        document.getElementById('profile-phone').value = defaults.phone;
        document.getElementById('profile-logo').value = defaults.logo;
        document.getElementById('profile-pin').value = defaults.pin;
        document.getElementById('profile-pin-confirm').value = defaults.pin;
        this.updatePreview();
        ToastManager.show('Perfil restablecido a valores por defecto', 'info', 'Perfil restablecido');
      }

      async confirmAction(title, message) {
        return await ModalManager.show(title, message, 'Confirmar', 'danger');
      }

      // M√©todo para limpiar interfaz antes de imprimir
      cleanForPrint() {
        // Ocultar todos los toasts
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(toast => toast.remove());
        
        // Ocultar panel de usuario (se restaurar√° autom√°ticamente despu√©s)
        const userPanel = document.querySelector('.modern-user-panel');
        if (userPanel) userPanel.style.display = 'none';
        
        // Ocultar cualquier modal o overlay
        const modals = document.querySelectorAll('.modal-overlay, .user-switch-panel, .profile-panel');
        modals.forEach(modal => modal.style.display = 'none');
      }

      // M√©todo para restaurar interfaz despu√©s de imprimir
      restoreAfterPrint() {
        // Restaurar panel de usuario
        const userPanel = document.querySelector('.modern-user-panel');
        if (userPanel) userPanel.style.display = 'block';
        
        // Cerrar cualquier panel que pudiera estar abierto
        const switchPanel = document.querySelector('.user-switch-panel');
        if (switchPanel) switchPanel.classList.remove('active');
        
        const profilePanel = document.querySelector('.modern-profile-panel');
        if (profilePanel) profilePanel.classList.remove('active');
        
        // Mostrar notificaci√≥n que la interfaz fue restaurada
        ToastManager.show('Panel de usuario restaurado. Puedes cambiar de cuenta si necesitas.', 'info', 'Interfaz restaurada');
        
        console.log('Interfaz restaurada despu√©s de imprimir');
      }

      // M√©todo de acceso r√°pido para cambiar usuario (atajo de teclado)
      setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          // Ctrl + U = Cambiar Usuario
          if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            this.showUserSwitcher();
            ToastManager.show('Panel de cambio de usuario abierto', 'info', 'Atajo de teclado');
          }
          
          // Ctrl + Shift + L = Cerrar Sesi√≥n
          if (e.ctrlKey && e.shiftKey && e.key === 'L') {
            e.preventDefault();
            this.logout();
          }
        });
      }
    }

    // Inicializar el sistema
    const manager = new ProformaManager();
    
    // Hacer disponible globalmente para los botones inline
    window.manager = manager;
    
    // Limpiar interfaz antes de imprimir
    window.addEventListener('beforeprint', () => {
      manager.cleanForPrint();
    });
    
    // Restaurar interfaz despu√©s de imprimir
    window.addEventListener('afterprint', () => {
      manager.restoreAfterPrint();
    });
    
    // Inicializar cuando se carga la p√°gina
    manager.init();
  </script>
</body>
</html>
